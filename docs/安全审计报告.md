# RBAC Admin Pro 安全审计报告

**审计日期**: 2025年12月10日  
**项目版本**: 当前开发版本  
**审计范围**: 前端 (Vue 3) + 后端 (NestJS) 全栈应用

---

## 一、总体评估

| 评估维度 | 评级 | 说明 |
|---------|------|------|
| 认证安全 | ⭐⭐⭐⭐⭐ | JWT + 两步验证 + 账户锁定 + Token 黑名单 |
| 授权控制 | ⭐⭐⭐⭐⭐ | RBAC 模型 + 按钮级权限 + 通配符匹配 |
| 数据安全 | ⭐⭐⭐⭐⭐ | Prisma ORM 防注入 + bcrypt 加密 + XSS 防护 |
| 传输安全 | ⭐⭐⭐⭐ | CORS 白名单 + 生产环境强制配置 |
| 文件安全 | ⭐⭐⭐⭐⭐ | MIME 校验 + 魔数验证 + SVG 清洗 |
| 日志审计 | ⭐⭐⭐⭐⭐ | 操作日志 + 登录日志 + Winston 分级 |

**综合评级**: ⭐⭐⭐⭐⭐ (优秀)

---

## 二、安全亮点 ✅

### 2.1 认证机制
- ✅ JWT Token 认证，支持滑动过期自动续签
- ✅ Token 黑名单机制（`TokenBlacklistService`，登出后 Token 立即失效）
- ✅ 两步验证 (TOTP) 支持（`TwoFactorService`，基于 otplib）
- ✅ 图形验证码防暴力破解（`CaptchaService`）
- ✅ 账户锁定机制（`SecurityConfigService`，登录失败次数限制 + 自动锁定）
- ✅ 密码使用 bcrypt 加盐哈希存储（salt rounds = 10）

### 2.2 授权控制
- ✅ 完整的 RBAC 权限模型
- ✅ 按钮级权限控制（`PermissionGuard` + `@RequirePermission` 装饰器）
- ✅ 权限通配符匹配（支持 `system:user:*`、`*:*:*` 等模式）
- ✅ 前端路由守卫 + 后端双重校验
- ✅ 超级管理员 (`admin`) 特殊权限处理

### 2.3 数据安全
- ✅ 使用 Prisma ORM，天然防 SQL 注入
- ✅ 全局 `ValidationPipe` 参数校验
- ✅ DTO 白名单模式（`whitelist: true`，自动剔除未定义属性）
- ✅ 敏感数据（密码）返回时自动过滤
- ✅ **XSS 防护**：后端 `sanitize-html` + 前端 `DOMPurify` 双重清洗

### 2.4 文件上传
- ✅ MIME 类型白名单校验
- ✅ 文件魔数 (Magic Number) 二次验证（`validateFileMagic`）
- ✅ SVG 文件 XSS 清洗（`sanitizeSvgBuffer`，移除 script、事件处理器）
- ✅ 文件大小限制（头像 2MB）
- ✅ 文件名清理防路径遍历

### 2.5 日志审计
- ✅ 操作日志完整记录（IP、浏览器、操作内容、耗时）
- ✅ 登录日志记录（成功/失败、地理位置、设备信息）
- ✅ Winston 日志分级 + 日志轮转（`daily-rotate-file`）
- ✅ 开发/生产环境日志格式自动切换

### 2.6 CORS 安全
- ✅ 生产环境强制配置白名单（未配置则拒绝所有跨域请求）
- ✅ 开发环境允许所有来源（便于调试）
- ✅ 暴露 `X-New-Token` 头用于滑动过期

---

## 三、安全风险与修复状态

### 3.1 已修复 ✅

#### ✅ H1: XSS 风险 - 公告内容 (已修复)
**原问题**: 公告内容直接使用 `v-html` 渲染，存在存储型 XSS 风险。

**修复方案**:
1. 后端：使用 `sanitize-html` 在创建/更新公告时清洗 HTML 内容
   - 新增 `server-nestjs/src/common/utils/sanitize-html.util.ts`
   - 修改 `notice.service.ts` 的 create/update 方法
2. 前端：使用 `DOMPurify` 在预览时二次清洗
   - 新增 `web/src/utils/sanitize.ts`
   - 修改预览使用 `sanitizedPreviewContent` 计算属性

---

### 3.2 中风险 ⚠️

#### 🟡 M1: 默认密码安全性
**位置**: 文档及种子数据
```
默认账号: admin / admin123
```
**风险**: 默认弱密码，生产环境若未修改易被攻击。

**建议**:
1. 首次登录强制修改密码
2. 部署文档中强调修改默认密码
3. 添加密码强度校验规则

#### 🟡 M2: JWT Secret 配置
**位置**: `server-nestjs/src/auth/auth.module.ts:27`
```typescript
secret: configService.get<string>('JWT_SECRET') || 'super-secret-key',
```
**风险**: 存在硬编码的默认密钥回退值。

**建议**:
1. 移除默认值，强制要求配置
2. 启动时检查 JWT_SECRET 是否为默认值并警告

#### 🟡 M3: 开发环境错误信息泄露
**位置**: `server-nestjs/.env.example`
```
ERROR_FULL=true
```
**风险**: 详细错误信息可能泄露系统内部结构。

**建议**: 生产环境确保 `ERROR_FULL=false`

#### 🟡 M4: Redis 无密码认证
**位置**: `docker-compose.yml`
```yaml
command: redis-server --appendonly yes
```
**风险**: Redis 未配置密码，若暴露在公网存在未授权访问风险。

**建议**: 生产环境配置 Redis 密码认证
```yaml
command: redis-server --appendonly yes --requirepass yourpassword
```

---

### 3.3 低风险 🟢

#### 🟢 L1: Swagger 文档生产环境暴露
**位置**: `server-nestjs/src/main.ts`
**风险**: API 文档在生产环境可访问，可能泄露接口信息。

**建议**: 生产环境禁用或添加认证保护
```typescript
if (process.env.NODE_ENV !== 'production') {
  SwaggerModule.setup('api-docs', app, document);
}
```

#### 🟢 L2: 静态文件目录暴露
**位置**: `server-nestjs/src/main.ts:33`
```typescript
app.useStaticAssets(join(process.cwd(), 'uploads'), { prefix: '/uploads/' });
```
**风险**: 上传目录可被直接访问，需确保无敏感文件。

**建议**: 添加访问控制或使用签名 URL

#### 🟢 L3: 缺少 Rate Limiting
**风险**: 未发现全局请求频率限制，可能遭受 DoS 攻击。

**建议**: 添加 `@nestjs/throttler` 限流模块
```typescript
import { ThrottlerModule } from '@nestjs/throttler';

ThrottlerModule.forRoot([{ ttl: 60000, limit: 100 }])
```

#### 🟢 L4: 缺少 Helmet 安全头
**风险**: 未配置安全响应头（CSP、X-Frame-Options 等）。

**建议**: 添加 `helmet` 中间件
```typescript
import helmet from 'helmet';
app.use(helmet());
```

---

## 四、合规性检查

| 检查项 | 状态 | 说明 |
|-------|------|------|
| 密码加密存储 | ✅ | bcrypt 加盐哈希 |
| 会话管理 | ✅ | JWT + 黑名单 + 超时控制 |
| 访问控制 | ✅ | RBAC + 权限守卫 |
| 审计日志 | ✅ | 操作日志 + 登录日志 |
| 输入验证 | ✅ | class-validator + Zod |
| XSS 防护 | ✅ | sanitize-html + DOMPurify |
| SQL 注入防护 | ✅ | Prisma ORM 参数化查询 |
| 文件上传安全 | ✅ | 类型校验 + 魔数验证 |
| 错误处理 | ✅ | 全局异常过滤器 |
| CORS 配置 | ✅ | 生产环境白名单模式 |
| HTTPS | ⚠️ | 需部署时配置 |
| CSP 头 | ❌ | 未配置 |
| Rate Limiting | ❌ | 未配置 |

---

## 五、修复建议优先级

### 部署前修复 (P1)
1. 移除 JWT Secret 默认值或启动时警告
2. 配置 Redis 密码
3. 生产环境禁用 Swagger 或添加认证
4. 强制修改默认管理员密码

### 建议优化 (P2)
5. 添加 Rate Limiting（`@nestjs/throttler`）
6. 添加 Helmet 安全头
7. 添加密码强度校验
8. 上传文件访问控制

---

## 六、安全配置清单

### 生产环境部署前检查
```bash
# .env 配置检查
NODE_ENV=production
ERROR_FULL=false
JWT_SECRET=<随机生成的64位字符串>
CORS_ORIGINS=https://your-domain.com
REDIS_URL=redis://:password@host:6379

# 生成安全的 JWT_SECRET
node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
```

### 部署检查清单
- [ ] 修改默认管理员密码
- [ ] 配置强随机 JWT_SECRET
- [ ] 配置 Redis 密码
- [ ] 配置数据库访问白名单
- [ ] 配置 HTTPS 证书
- [ ] 配置防火墙规则
- [ ] Redis 不暴露公网
- [ ] 禁用或保护 Swagger 文档

---

## 七、安全架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                         前端 (Vue 3)                            │
├─────────────────────────────────────────────────────────────────┤
│  路由守卫 → 权限指令 → DOMPurify XSS 清洗 → Axios 拦截器       │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                       后端 (NestJS)                             │
├─────────────────────────────────────────────────────────────────┤
│  CORS 白名单                                                    │
│       │                                                         │
│       ▼                                                         │
│  ValidationPipe (参数校验 + 白名单)                             │
│       │                                                         │
│       ▼                                                         │
│  JwtAuthGuard (Token 验证 + 黑名单检查 + 滑动过期)              │
│       │                                                         │
│       ▼                                                         │
│  PermissionGuard (RBAC 权限校验)                                │
│       │                                                         │
│       ▼                                                         │
│  Controller → Service → Prisma ORM (防 SQL 注入)                │
│       │                                                         │
│       ▼                                                         │
│  sanitize-html (XSS 清洗) + 文件魔数验证 + SVG 清洗             │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                      数据层                                     │
├─────────────────────────────────────────────────────────────────┤
│  PostgreSQL (bcrypt 密码) │ Redis (Token 黑名单 + 账户锁定)     │
└─────────────────────────────────────────────────────────────────┘
```

---

**审计结论**: 项目安全架构设计优秀，核心安全机制完善。XSS 漏洞已修复，建议在生产部署前完成中风险项的配置优化。

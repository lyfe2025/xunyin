# Xunyin Admin ä¼˜åŒ–å»ºè®®æ¸…å•

> **ç”Ÿæˆæ—¥æœŸ:** 2025-12-31  
> **é¡¹ç›®çŠ¶æ€:** æ ¸å¿ƒåŠŸèƒ½å·²å®Œæˆï¼Œè¿›å…¥ä¼˜åŒ–é˜¶æ®µ  
> **æœ¬æ–‡æ¡£ç›®çš„:** æä¾›å¯é€‰ä¼˜åŒ–é¡¹ï¼ŒæŒ‰ä¼˜å…ˆçº§åˆ†ç±»ï¼Œä¾›åç»­è¿­ä»£å‚è€ƒ

---

## âœ… å·²å®ç°åŠŸèƒ½æ¸…å•

åœ¨å¼€å§‹ä¼˜åŒ–å»ºè®®ä¹‹å‰ï¼Œå…ˆç¡®è®¤é¡¹ç›®å·²å…·å¤‡çš„èƒ½åŠ›ï¼š

| åŠŸèƒ½ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| Winston æ—¥å¿—ç³»ç»Ÿ | âœ… | æ”¯æŒæ—¥å¿—åˆ†çº§ã€æ–‡ä»¶è½®è½¬ã€ç”Ÿäº§ç¯å¢ƒ JSON æ ¼å¼ |
| HTTP è¯·æ±‚æ—¥å¿— | âœ… | `HttpLoggerMiddleware` è®°å½•è¯·æ±‚è¯¦æƒ…å’Œè€—æ—¶ |
| ç»Ÿä¸€å¼‚å¸¸å¤„ç† | âœ… | `AllExceptionsFilter` + `BusinessException` |
| é”™è¯¯ç ä½“ç³» | âœ… | `ErrorCode` æšä¸¾ + æ¶ˆæ¯æ˜ å°„ |
| XSS é˜²æŠ¤ | âœ… | `sanitize-html` å·¥å…·å‡½æ•° |
| è´¦æˆ·é”å®šæœºåˆ¶ | âœ… | `SecurityConfigService` ç™»å½•å¤±è´¥æ¬¡æ•°é™åˆ¶ |
| Redis æœåŠ¡ | âœ… | æ”¯æŒçœŸå® Redis å’Œå†…å­˜æ¨¡å¼é™çº§ |
| å‚æ•°æ ¡éªŒ | âœ… | `ValidationPipe` + class-validator |
| CORS é…ç½® | âœ… | ç”Ÿäº§ç¯å¢ƒç™½åå•æ§åˆ¶ |
| Swagger æ–‡æ¡£ | âœ… | Swagger UI + Redoc åŒæ–‡æ¡£ |
| æœåŠ¡å™¨ç›‘æ§ | âœ… | CPU/å†…å­˜/ç£ç›˜ç›‘æ§ |
| æ•°æ®åº“ç›‘æ§ | âœ… | è¿æ¥çŠ¶æ€ç›‘æ§ |
| ç¼“å­˜ç›‘æ§ | âœ… | Redis çŠ¶æ€ç›‘æ§ |
| å®šæ—¶ä»»åŠ¡ | âœ… | `@nestjs/schedule` æ”¯æŒ |
| æ–‡ä»¶ä¸Šä¼  | âœ… | æœ¬åœ° + S3 å­˜å‚¨ |
| é‚®ä»¶æœåŠ¡ | âœ… | Nodemailer é›†æˆ |
| Excel å¯¼å‡º | âœ… | ExcelJS é›†æˆ |

---

## ğŸ“Š ä¼˜åŒ–é¡¹æ€»è§ˆ

| åˆ†ç±» | é«˜ä¼˜å…ˆçº§ | ä¸­ä¼˜å…ˆçº§ | ä½ä¼˜å…ˆçº§ |
|------|----------|----------|----------|
| å®‰å…¨åŠ å›º | 2 | 1 | 1 |
| æ€§èƒ½ä¼˜åŒ– | 2 | 2 | 1 |
| ä»£ç è´¨é‡ | 1 | 2 | 1 |
| å¯è§‚æµ‹æ€§ | 1 | 1 | 1 |
| éƒ¨ç½²è¿ç»´ | 1 | 1 | 1 |

---

## ğŸ”´ é«˜ä¼˜å…ˆçº§ï¼ˆå»ºè®®å°½å¿«å®æ–½ï¼‰

### 1. å®‰å…¨åŠ å›º

#### 1.1 æ·»åŠ  Rate Limitingï¼ˆæ¥å£é™æµï¼‰

**é—®é¢˜:** ç™»å½•ã€éªŒè¯ç ç­‰æ•æ„Ÿæ¥å£æ—  IP çº§åˆ«é™æµä¿æŠ¤ï¼Œå­˜åœ¨æš´åŠ›ç ´è§£å’ŒçŸ­ä¿¡è½°ç‚¸é£é™©ã€‚

**ç°çŠ¶åˆ†æ:**
- âœ… å·²æœ‰è´¦æˆ·é”å®šæœºåˆ¶ï¼ˆ`SecurityConfigService`ï¼‰
- âŒ ç¼ºå°‘ IP çº§åˆ«çš„è¯·æ±‚é¢‘ç‡é™åˆ¶
- âŒ App ç«¯ SMS éªŒè¯ç æ¥å£æ— é˜²åˆ·ä¿æŠ¤

**å»ºè®®æ–¹æ¡ˆ:**
```bash
pnpm add @nestjs/throttler
```

```typescript
// app.module.ts
import { ThrottlerModule, ThrottlerGuard } from '@nestjs/throttler';

@Module({
  imports: [
    ThrottlerModule.forRoot([
      { name: 'short', ttl: 1000, limit: 3 },      // 1ç§’3æ¬¡
      { name: 'medium', ttl: 10000, limit: 20 },   // 10ç§’20æ¬¡
      { name: 'long', ttl: 60000, limit: 100 },    // 1åˆ†é’Ÿ100æ¬¡
    ]),
  ],
  providers: [
    { provide: APP_GUARD, useClass: ThrottlerGuard },
  ],
})
```

```typescript
// app-auth.controller.ts - SMS éªŒè¯ç é™æµ
@Throttle({ short: { limit: 1, ttl: 60000 } }) // 1åˆ†é’Ÿæœ€å¤š1æ¬¡
@Post('sms/send')
async sendSmsCode(@Body() dto: SendSmsDto) {}

// auth.controller.ts - ç™»å½•é™æµ
@Throttle({ short: { limit: 5, ttl: 60000 } }) // 1åˆ†é’Ÿæœ€å¤š5æ¬¡
@Post('login')
async login(@Body() dto: LoginDto) {}
```

**å·¥ä½œé‡:** çº¦ 2 å°æ—¶

---

#### 1.2 æ·»åŠ  Helmet å®‰å…¨å“åº”å¤´

**é—®é¢˜:** ç¼ºå°‘å¸¸è§çš„å®‰å…¨å“åº”å¤´ï¼Œå¯èƒ½å—åˆ° XSSã€ç‚¹å‡»åŠ«æŒç­‰æ”»å‡»ã€‚

**å»ºè®®æ–¹æ¡ˆ:**
```bash
pnpm add helmet
```

```typescript
// main.ts
import helmet from 'helmet';

async function bootstrap() {
  const app = await NestFactory.create(AppModule);
  
  app.use(helmet({
    contentSecurityPolicy: {
      directives: {
        defaultSrc: ["'self'"],
        styleSrc: ["'self'", "'unsafe-inline'"],
        imgSrc: ["'self'", 'data:', 'https:'],
        scriptSrc: ["'self'"],
      },
    },
    crossOriginEmbedderPolicy: false,
  }));
}
```

**å·¥ä½œé‡:** çº¦ 30 åˆ†é’Ÿ

---

### 2. æ€§èƒ½ä¼˜åŒ–

#### 2.1 æ·»åŠ  Response å‹ç¼©

**é—®é¢˜:** API å“åº”æœªå‹ç¼©ï¼Œå¢åŠ ç½‘ç»œä¼ è¾“æ—¶é—´ã€‚

**å»ºè®®æ–¹æ¡ˆ:**
```bash
pnpm add compression @types/compression
```

```typescript
// main.ts
import compression from 'compression';

async function bootstrap() {
  const app = await NestFactory.create(AppModule);
  
  app.use(compression({
    threshold: 1024, // åªå‹ç¼©å¤§äº 1KB çš„å“åº”
    level: 6,
  }));
}
```

**æ•ˆæœ:** JSON å“åº”ä½“ç§¯é€šå¸¸å¯å‡å°‘ 60-80%

**å·¥ä½œé‡:** çº¦ 15 åˆ†é’Ÿ

---

#### 2.2 æ·»åŠ å¥åº·æ£€æŸ¥ç«¯ç‚¹

**é—®é¢˜:** ç¼ºå°‘æ ‡å‡†å¥åº·æ£€æŸ¥ç«¯ç‚¹ï¼Œä¸åˆ©äºå®¹å™¨ç¼–æ’å’Œè´Ÿè½½å‡è¡¡ã€‚

**ç°çŠ¶åˆ†æ:**
- âœ… å·²æœ‰æœåŠ¡å™¨ç›‘æ§ï¼ˆ`/api/monitor/server`ï¼‰
- âŒ éœ€è¦ç®¡ç†å‘˜æƒé™ï¼Œä¸é€‚åˆ K8s/Docker å¥åº·æ£€æŸ¥
- âŒ ç¼ºå°‘ liveness/readiness åˆ†ç¦»

**å»ºè®®æ–¹æ¡ˆ:**
```bash
pnpm add @nestjs/terminus
```

```typescript
// health/health.module.ts
import { Module } from '@nestjs/common';
import { TerminusModule } from '@nestjs/terminus';
import { HealthController } from './health.controller';
import { PrismaHealthIndicator } from './prisma.health';

@Module({
  imports: [TerminusModule],
  controllers: [HealthController],
  providers: [PrismaHealthIndicator],
})
export class HealthModule {}

// health/health.controller.ts
@Controller('health')
export class HealthController {
  constructor(
    private health: HealthCheckService,
    private memory: MemoryHealthIndicator,
    private prisma: PrismaHealthIndicator,
  ) {}

  @Get()
  @HealthCheck()
  check() {
    return this.health.check([
      () => this.prisma.isHealthy('database'),
      () => this.memory.checkHeap('memory_heap', 500 * 1024 * 1024),
    ]);
  }

  @Get('liveness')
  liveness() {
    return { status: 'ok' };
  }

  @Get('readiness')
  @HealthCheck()
  readiness() {
    return this.health.check([
      () => this.prisma.isHealthy('database'),
    ]);
  }
}
```

**å·¥ä½œé‡:** çº¦ 1.5 å°æ—¶

---

### 3. ä»£ç è´¨é‡

#### 3.1 Service å±‚äº‹åŠ¡å¤„ç†

**é—®é¢˜:** éƒ¨åˆ†æ¶‰åŠå¤šè¡¨æ“ä½œçš„æ–¹æ³•æœªä½¿ç”¨äº‹åŠ¡ï¼Œå¯èƒ½å¯¼è‡´æ•°æ®ä¸ä¸€è‡´ã€‚

**ç°çŠ¶åˆ†æ:**
```typescript
// journey.service.ts - startJourney æ–¹æ³•
// åˆ›å»ºè¿›åº¦ + è®°å½•åŠ¨æ€ï¼Œä¸¤ä¸ªæ“ä½œæœªåœ¨äº‹åŠ¡ä¸­
const progress = await this.prisma.journeyProgress.create({ ... });
await this.prisma.userActivity.create({ ... });
```

**å»ºè®®æ–¹æ¡ˆ:**
```typescript
async startJourney(userId: string, journeyId: string) {
  return this.prisma.$transaction(async (tx) => {
    const journey = await tx.journey.findUnique({ where: { id: journeyId } });
    if (!journey || journey.status !== '0') {
      throw new BusinessException(ErrorCode.DATA_NOT_FOUND, 'æ–‡åŒ–ä¹‹æ—…ä¸å­˜åœ¨');
    }

    if (journey.isLocked) {
      throw new BusinessException(ErrorCode.OPERATION_DENIED, 'æ–‡åŒ–ä¹‹æ—…å°šæœªè§£é”');
    }

    // æ£€æŸ¥ç°æœ‰è¿›åº¦...
    
    const progress = await tx.journeyProgress.create({
      data: { userId, journeyId, status: 'in_progress', startTime: new Date() },
    });

    await tx.userActivity.create({
      data: {
        userId,
        type: 'journey_started',
        title: `å¼€å§‹äº†ã€Œ${journey.name}ã€æ–‡åŒ–ä¹‹æ—…`,
        relatedId: journeyId,
      },
    });

    return { progressId: progress.id, journeyId, startTime: progress.startTime };
  });
}
```

**é€‚ç”¨åœºæ™¯:**
- å¼€å§‹/å®Œæˆæ–‡åŒ–ä¹‹æ—…
- è·å¾—å°è®°
- ç”¨æˆ·æ³¨å†Œï¼ˆåˆ›å»ºç”¨æˆ· + åˆå§‹åŒ–æ•°æ®ï¼‰

**å·¥ä½œé‡:** çº¦ 2 å°æ—¶

---

### 4. å¯è§‚æµ‹æ€§

#### 4.1 æ·»åŠ è¯·æ±‚è¿½è¸ª ID

**é—®é¢˜:** æ—¥å¿—ç¼ºå°‘è¯·æ±‚è¿½è¸ª IDï¼Œéš¾ä»¥å…³è”åŒä¸€è¯·æ±‚çš„å¤šæ¡æ—¥å¿—ã€‚

**å»ºè®®æ–¹æ¡ˆ:**

```typescript
// common/middleware/request-id.middleware.ts
import { Injectable, NestMiddleware } from '@nestjs/common';
import { Request, Response, NextFunction } from 'express';
import { randomUUID } from 'crypto';

declare global {
  namespace Express {
    interface Request {
      requestId: string;
    }
  }
}

@Injectable()
export class RequestIdMiddleware implements NestMiddleware {
  use(req: Request, res: Response, next: NextFunction) {
    const requestId = (req.headers['x-request-id'] as string) || randomUUID();
    req.requestId = requestId;
    res.setHeader('X-Request-ID', requestId);
    next();
  }
}

// æ›´æ–° http-logger.middleware.ts
use(req: Request, res: Response, next: NextFunction) {
  const requestId = req.requestId || 'unknown';
  // åœ¨æ—¥å¿—ä¸­åŒ…å« requestId
  this.logger.http(logMessage, { requestId, method, url, ... });
}
```

**å·¥ä½œé‡:** çº¦ 1 å°æ—¶

---

### 5. éƒ¨ç½²è¿ç»´

#### 5.1 Graceful Shutdown

**é—®é¢˜:** æœåŠ¡é‡å¯æ—¶å¯èƒ½ä¸­æ–­æ­£åœ¨å¤„ç†çš„è¯·æ±‚ã€‚

**å»ºè®®æ–¹æ¡ˆ:**

```typescript
// main.ts
async function bootstrap() {
  const app = await NestFactory.create(AppModule);
  
  // å¯ç”¨ä¼˜é›…å…³é—­
  app.enableShutdownHooks();
  
  const logger = app.get(LoggerService);
  
  process.on('SIGTERM', async () => {
    logger.log('æ”¶åˆ° SIGTERM ä¿¡å·ï¼Œå¼€å§‹ä¼˜é›…å…³é—­...', 'Bootstrap');
    await app.close();
    process.exit(0);
  });
  
  process.on('SIGINT', async () => {
    logger.log('æ”¶åˆ° SIGINT ä¿¡å·ï¼Œå¼€å§‹ä¼˜é›…å…³é—­...', 'Bootstrap');
    await app.close();
    process.exit(0);
  });
}

// prisma.service.ts - å·²æœ‰ onModuleDestroyï¼Œç¡®è®¤å®ç°
async onModuleDestroy() {
  await this.$disconnect();
}
```

**å·¥ä½œé‡:** çº¦ 30 åˆ†é’Ÿ

---

## ğŸŸ¡ ä¸­ä¼˜å…ˆçº§ï¼ˆå»ºè®®åœ¨åç»­è¿­ä»£ä¸­å®æ–½ï¼‰

### 6. å®‰å…¨åŠ å›ºï¼ˆç»­ï¼‰

#### 6.1 æ•æ„Ÿæ•°æ®è„±æ•

**é—®é¢˜:** æ—¥å¿—å’Œ API å“åº”ä¸­å¯èƒ½æš´éœ²æ•æ„Ÿä¿¡æ¯ã€‚

**å»ºè®®æ–¹æ¡ˆ:**

```typescript
// common/utils/desensitize.util.ts
export class DesensitizeUtil {
  /** æ‰‹æœºå·è„±æ•: 138****1234 */
  static phone(phone: string): string {
    if (!phone || phone.length < 7) return phone;
    return phone.replace(/(\d{3})\d{4}(\d+)/, '$1****$2');
  }

  /** é‚®ç®±è„±æ•: a***@example.com */
  static email(email: string): string {
    if (!email) return email;
    const [name, domain] = email.split('@');
    if (!domain) return email;
    return `${name[0]}***@${domain}`;
  }

  /** è¯·æ±‚å‚æ•°è„±æ•ï¼ˆç”¨äºæ—¥å¿—ï¼‰ */
  static sanitizeParams(params: Record<string, unknown>): Record<string, unknown> {
    const sensitiveKeys = ['password', 'token', 'secret', 'code', 'smsCode'];
    const result = { ...params };
    
    for (const key of Object.keys(result)) {
      if (sensitiveKeys.some(sk => key.toLowerCase().includes(sk))) {
        result[key] = '******';
      }
    }
    return result;
  }
}
```

**å·¥ä½œé‡:** çº¦ 2 å°æ—¶

---

### 7. æ€§èƒ½ä¼˜åŒ–ï¼ˆç»­ï¼‰

#### 7.1 æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ– - ä½¿ç”¨ select

**é—®é¢˜:** éƒ¨åˆ†æŸ¥è¯¢è¿”å›äº†ä¸å¿…è¦çš„å­—æ®µï¼Œå¢åŠ æ•°æ®ä¼ è¾“é‡ã€‚

**å»ºè®®æ–¹æ¡ˆ:**
```typescript
// ä¼˜åŒ–å‰
const cities = await this.prisma.city.findMany({
  where: { status: '0' },
});

// ä¼˜åŒ–å - åªè¿”å›éœ€è¦çš„å­—æ®µ
const cities = await this.prisma.city.findMany({
  where: { status: '0' },
  select: {
    id: true,
    name: true,
    province: true,
    latitude: true,
    longitude: true,
    iconAsset: true,
    coverImage: true,
    description: true,
    explorerCount: true,
    bgmUrl: true,
  },
  orderBy: { orderNum: 'asc' },
});
```

**å·¥ä½œé‡:** çº¦ 3 å°æ—¶ï¼ˆéœ€è¦é€ä¸ª Service ä¼˜åŒ–ï¼‰

---

#### 7.2 æ·»åŠ  Redis ç¼“å­˜å±‚

**é—®é¢˜:** å­—å…¸æ•°æ®ã€åŸå¸‚åˆ—è¡¨ç­‰å˜åŒ–ä¸é¢‘ç¹çš„æ•°æ®æ¯æ¬¡éƒ½æŸ¥æ•°æ®åº“ã€‚

**å»ºè®®æ–¹æ¡ˆ:**

```typescript
// common/cache/cache.service.ts
@Injectable()
export class CacheService {
  private readonly DEFAULT_TTL = 300; // 5åˆ†é’Ÿ

  constructor(private redis: RedisService) {}

  async getOrSet<T>(key: string, factory: () => Promise<T>, ttl = this.DEFAULT_TTL): Promise<T> {
    const client = this.redis.getClient();
    const cached = await client.get(key);
    if (cached) return JSON.parse(cached) as T;

    const data = await factory();
    await client.setex(key, ttl, JSON.stringify(data));
    return data;
  }

  async invalidate(pattern: string): Promise<void> {
    // æ¸…é™¤åŒ¹é…çš„ç¼“å­˜
  }
}

// ä½¿ç”¨ç¤ºä¾‹ - city.service.ts
async findAll(query: QueryCityDto) {
  const cacheKey = `cities:list:${query.province || 'all'}`;
  
  return this.cacheService.getOrSet(cacheKey, async () => {
    const cities = await this.prisma.city.findMany({
      where: { status: '0', ...(query.province && { province: query.province }) },
      orderBy: { orderNum: 'asc' },
    });
    return cities.map(city => ({ /* ... */ }));
  }, 600); // ç¼“å­˜10åˆ†é’Ÿ
}
```

**é€‚ç”¨æ•°æ®:**
- å­—å…¸æ•°æ®ï¼ˆ`sys_dict_data`ï¼‰
- åŸå¸‚åˆ—è¡¨
- ç³»ç»Ÿé…ç½®ï¼ˆ`sys_config`ï¼‰

**å·¥ä½œé‡:** çº¦ 4 å°æ—¶

---

### 8. ä»£ç è´¨é‡ï¼ˆç»­ï¼‰

#### 8.1 DTO æ ¡éªŒå¢å¼º

**å»ºè®®å¢å¼º:**

```typescript
// common/decorators/validators.ts
import { registerDecorator, ValidationOptions } from 'class-validator';

/** ä¸­å›½æ‰‹æœºå·æ ¡éªŒ */
export function IsChinesePhone(validationOptions?: ValidationOptions) {
  return function (object: object, propertyName: string) {
    registerDecorator({
      name: 'isChinesePhone',
      target: object.constructor,
      propertyName,
      options: validationOptions,
      validator: {
        validate(value: unknown) {
          return typeof value === 'string' && /^1[3-9]\d{9}$/.test(value);
        },
        defaultMessage() {
          return 'è¯·è¾“å…¥æœ‰æ•ˆçš„æ‰‹æœºå·';
        },
      },
    });
  };
}

/** å®‰å…¨å­—ç¬¦ä¸²ï¼ˆé˜² XSSï¼‰ */
export function IsSafeString(validationOptions?: ValidationOptions) {
  return function (object: object, propertyName: string) {
    registerDecorator({
      name: 'isSafeString',
      target: object.constructor,
      propertyName,
      options: validationOptions,
      validator: {
        validate(value: unknown) {
          if (typeof value !== 'string') return false;
          return !/<[^>]*>|javascript:|on\w+=/i.test(value);
        },
        defaultMessage() {
          return 'åŒ…å«ä¸å®‰å…¨å­—ç¬¦';
        },
      },
    });
  };
}
```

**å·¥ä½œé‡:** çº¦ 2 å°æ—¶

---

#### 8.2 ç¯å¢ƒå˜é‡æ ¡éªŒ

**é—®é¢˜:** å¯åŠ¨æ—¶ä¸æ£€æŸ¥å¿…è¦ç¯å¢ƒå˜é‡ï¼Œå¯èƒ½å¯¼è‡´è¿è¡Œæ—¶é”™è¯¯ã€‚

**å»ºè®®æ–¹æ¡ˆ:**

```typescript
// config/env.validation.ts
import { plainToInstance } from 'class-transformer';
import { IsString, IsNumber, IsOptional, validateSync, IsIn } from 'class-validator';

class EnvironmentVariables {
  @IsNumber()
  PORT: number = 3000;

  @IsIn(['development', 'production', 'test'])
  NODE_ENV: string = 'development';

  @IsString()
  DATABASE_URL: string;

  @IsString()
  JWT_SECRET: string;

  @IsOptional()
  @IsString()
  REDIS_URL?: string;
}

export function validate(config: Record<string, unknown>) {
  const validatedConfig = plainToInstance(EnvironmentVariables, config, {
    enableImplicitConversion: true,
  });
  
  const errors = validateSync(validatedConfig, { skipMissingProperties: false });

  if (errors.length > 0) {
    const messages = errors.map(e => Object.values(e.constraints || {}).join(', '));
    throw new Error(`ç¯å¢ƒå˜é‡æ ¡éªŒå¤±è´¥:\n${messages.join('\n')}`);
  }
  
  return validatedConfig;
}

// app.module.ts
ConfigModule.forRoot({
  isGlobal: true,
  validate,
})
```

**å·¥ä½œé‡:** çº¦ 1 å°æ—¶

---

### 9. å¯è§‚æµ‹æ€§ï¼ˆç»­ï¼‰

#### 9.1 æ…¢è¯·æ±‚ç›‘æ§

**é—®é¢˜:** ç¼ºå°‘æ…¢è¯·æ±‚ç›‘æ§ï¼Œéš¾ä»¥å‘ç°æ€§èƒ½ç“¶é¢ˆã€‚

**å»ºè®®æ–¹æ¡ˆ:**

```typescript
// common/interceptors/performance.interceptor.ts
@Injectable()
export class PerformanceInterceptor implements NestInterceptor {
  private readonly logger = new Logger('Performance');
  private readonly SLOW_THRESHOLD = 1000; // 1ç§’

  intercept(context: ExecutionContext, next: CallHandler): Observable<unknown> {
    const request = context.switchToHttp().getRequest();
    const { method, url } = request;
    const startTime = Date.now();

    return next.handle().pipe(
      tap(() => {
        const duration = Date.now() - startTime;
        if (duration > this.SLOW_THRESHOLD) {
          this.logger.warn(`ğŸ¢ æ…¢è¯·æ±‚: ${method} ${url} - ${duration}ms`);
        }
      }),
    );
  }
}
```

**å·¥ä½œé‡:** çº¦ 30 åˆ†é’Ÿ

---

### 10. éƒ¨ç½²è¿ç»´ï¼ˆç»­ï¼‰

#### 10.1 Docker é•œåƒä¼˜åŒ–

**é—®é¢˜:** å½“å‰é•œåƒè¾ƒå¤§ï¼Œå¯ä»¥è¿›ä¸€æ­¥ä¼˜åŒ–ã€‚

**å»ºè®®æ–¹æ¡ˆ:**

```dockerfile
# å¤šé˜¶æ®µæ„å»ºä¼˜åŒ–
FROM node:20-alpine AS builder
WORKDIR /app
COPY package.json pnpm-lock.yaml ./
RUN corepack enable && pnpm install --frozen-lockfile
COPY . .
RUN pnpm build && pnpm prune --prod

FROM node:20-alpine AS runner
WORKDIR /app
COPY --from=builder /app/dist ./dist
COPY --from=builder /app/node_modules ./node_modules
COPY --from=builder /app/package.json ./
COPY --from=builder /app/prisma ./prisma

RUN addgroup -g 1001 -S nodejs && adduser -S nestjs -u 1001
USER nestjs

EXPOSE 3000
CMD ["node", "dist/src/main.js"]
```

**æ•ˆæœ:** é•œåƒä½“ç§¯å¯å‡å°‘ 30-50%

**å·¥ä½œé‡:** çº¦ 1 å°æ—¶

---

## ğŸŸ¢ ä½ä¼˜å…ˆçº§ï¼ˆå¯é€‰ä¼˜åŒ–ï¼‰

### 11. å®‰å…¨åŠ å›ºï¼ˆç»­ï¼‰

#### 11.1 SQL æ³¨å…¥é˜²æŠ¤å¢å¼º

**ç°çŠ¶:** Prisma ORM å·²æä¾›åŸºæœ¬çš„ SQL æ³¨å…¥é˜²æŠ¤ âœ…

**å»ºè®®:** å¯¹äº `$queryRaw` ä½¿ç”¨åœºæ™¯ï¼Œç¡®ä¿ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢

```typescript
// âœ… å®‰å…¨å†™æ³•ï¼ˆPrisma æ¨¡æ¿å­—ç¬¦ä¸²è‡ªåŠ¨å‚æ•°åŒ–ï¼‰
const result = await prisma.$queryRaw`SELECT * FROM users WHERE name = ${userInput}`;
```

**å·¥ä½œé‡:** ä»£ç å®¡æŸ¥çº¦ 1 å°æ—¶

---

### 12. æ€§èƒ½ä¼˜åŒ–ï¼ˆç»­ï¼‰

#### 12.1 å›¾ç‰‡å¤„ç†ä¼˜åŒ–

**é—®é¢˜:** ä¸Šä¼ çš„å›¾ç‰‡æœªè¿›è¡Œå‹ç¼©å’Œæ ¼å¼è½¬æ¢ã€‚

**å»ºè®®æ–¹æ¡ˆ:**
```bash
pnpm add sharp
```

```typescript
// common/upload/image.service.ts
import sharp from 'sharp';

@Injectable()
export class ImageService {
  async processImage(buffer: Buffer, options: {
    width?: number;
    quality?: number;
    format?: 'jpeg' | 'webp' | 'png';
  } = {}): Promise<Buffer> {
    const { width = 1920, quality = 80, format = 'webp' } = options;
    
    return sharp(buffer)
      .resize(width, undefined, { fit: 'inside', withoutEnlargement: true })
      [format]({ quality })
      .toBuffer();
  }

  async generateThumbnail(buffer: Buffer, size = 200): Promise<Buffer> {
    return sharp(buffer)
      .resize(size, size, { fit: 'cover' })
      .webp({ quality: 70 })
      .toBuffer();
  }
}
```

**å·¥ä½œé‡:** çº¦ 3 å°æ—¶

---

### 13. ä»£ç è´¨é‡ï¼ˆç»­ï¼‰

#### 13.1 ç»Ÿä¸€åˆ†é¡µå“åº”æ ¼å¼

**å»ºè®®æ–¹æ¡ˆ:**

```typescript
// common/vo/pagination.vo.ts
export class PaginatedVo<T> {
  list: T[];
  total: number;
  pageNum: number;
  pageSize: number;
  totalPages: number;
  hasNext: boolean;

  static create<T>(list: T[], total: number, pageNum: number, pageSize: number): PaginatedVo<T> {
    const totalPages = Math.ceil(total / pageSize);
    return { list, total, pageNum, pageSize, totalPages, hasNext: pageNum < totalPages };
  }
}
```

**å·¥ä½œé‡:** çº¦ 2 å°æ—¶

---

### 14. å¯è§‚æµ‹æ€§ï¼ˆç»­ï¼‰

#### 14.1 ä¸šåŠ¡æŒ‡æ ‡åŸ‹ç‚¹

**å»ºè®®åŸ‹ç‚¹æŒ‡æ ‡:**

| æŒ‡æ ‡å | ç±»å‹ | è¯´æ˜ |
|--------|------|------|
| `user.login` | Counter | ç”¨æˆ·ç™»å½•æ¬¡æ•° |
| `user.register` | Counter | æ–°ç”¨æˆ·æ³¨å†Œ |
| `journey.started` | Counter | æ–‡åŒ–ä¹‹æ—…å¼€å§‹ |
| `journey.completed` | Counter | æ–‡åŒ–ä¹‹æ—…å®Œæˆ |
| `seal.earned` | Counter | å°è®°è·å¾— |
| `api.latency` | Histogram | API å“åº”æ—¶é—´ |

**å·¥ä½œé‡:** çº¦ 3 å°æ—¶

---

## ğŸ“‹ å®æ–½å»ºè®®

### æ¨èå®æ–½é¡ºåº

| é˜¶æ®µ | ä¼˜åŒ–é¡¹ | é¢„è®¡å·¥æ—¶ | æ”¶ç›Š |
|------|--------|----------|------|
| **ç¬¬ä¸€é˜¶æ®µ** | Rate Limiting | 2h | å®‰å…¨æ€§å¤§å¹…æå‡ |
| **ç¬¬ä¸€é˜¶æ®µ** | Helmet | 0.5h | å®‰å…¨æ€§æå‡ |
| **ç¬¬ä¸€é˜¶æ®µ** | Response å‹ç¼© | 0.5h | æ€§èƒ½æå‡ |
| **ç¬¬ä¸€é˜¶æ®µ** | Graceful Shutdown | 0.5h | ç¨³å®šæ€§æå‡ |
| **ç¬¬äºŒé˜¶æ®µ** | å¥åº·æ£€æŸ¥ç«¯ç‚¹ | 1.5h | è¿ç»´å‹å¥½ |
| **ç¬¬äºŒé˜¶æ®µ** | è¯·æ±‚è¿½è¸ª ID | 1h | é—®é¢˜æ’æŸ¥æ•ˆç‡ |
| **ç¬¬äºŒé˜¶æ®µ** | äº‹åŠ¡å¤„ç†å®Œå–„ | 2h | æ•°æ®ä¸€è‡´æ€§ |
| **ç¬¬ä¸‰é˜¶æ®µ** | æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ– | 3h | æ€§èƒ½æå‡ |
| **ç¬¬ä¸‰é˜¶æ®µ** | Redis ç¼“å­˜å±‚ | 4h | æ€§èƒ½æå‡ |
| **ç¬¬ä¸‰é˜¶æ®µ** | ç¯å¢ƒå˜é‡æ ¡éªŒ | 1h | å¯åŠ¨å®‰å…¨ |

### å¿«é€Ÿè§æ•ˆé¡¹ï¼ˆæ¨èç«‹å³å®æ–½ï¼‰

1. **Helmet** - 30 åˆ†é’Ÿï¼Œé›¶é£é™©ï¼Œå®‰å…¨æ€§æå‡
2. **Response å‹ç¼©** - 15 åˆ†é’Ÿï¼Œé›¶é£é™©ï¼Œæ€§èƒ½æå‡
3. **Graceful Shutdown** - 30 åˆ†é’Ÿï¼Œç¨³å®šæ€§æå‡

### æ³¨æ„äº‹é¡¹

1. **Rate Limiting** éœ€è¦åœ¨æµ‹è¯•ç¯å¢ƒå……åˆ†éªŒè¯é˜ˆå€¼è®¾ç½®
2. **ç¼“å­˜å±‚** éœ€è¦è€ƒè™‘ç¼“å­˜å¤±æ•ˆç­–ç•¥
3. æ‰€æœ‰ä¼˜åŒ–å»ºè®®åœ¨å®æ–½å‰å»ºè®®å…ˆåœ¨å¼€å‘ç¯å¢ƒéªŒè¯

---

## ğŸ“š å‚è€ƒèµ„æº

- [NestJS å®˜æ–¹æ–‡æ¡£](https://docs.nestjs.com/)
- [Prisma æ€§èƒ½ä¼˜åŒ–æŒ‡å—](https://www.prisma.io/docs/guides/performance-and-optimization)
- [OWASP å®‰å…¨æœ€ä½³å®è·µ](https://owasp.org/www-project-web-security-testing-guide/)

---

**æ–‡æ¡£ç»´æŠ¤è€…:** å¼€å‘å›¢é˜Ÿ  
**æœ€åæ›´æ–°:** 2025-12-31

# Xunyin ä¼˜åŒ–å»ºè®®æ¸…å•

> **ç”Ÿæˆæ—¥æœŸ:** 2025-12-31  
> **æœ¬æ–‡æ¡£ç›®çš„:** æä¾›å¯é€‰ä¼˜åŒ–é¡¹ï¼ŒæŒ‰ç«¯åˆ†ç±»ã€æŒ‰ä¼˜å…ˆçº§æ’åºï¼Œä¾›åç»­è¿­ä»£å‚è€ƒ

---

## ğŸ“± é¡¹ç›®ç«¯è¯´æ˜

| ç«¯ | ç›®å½• | çŠ¶æ€ | è¯´æ˜ |
|---|------|------|------|
| **åç«¯ API** | `server-nestjs/` | âœ… å·²å®Œæˆ | NestJS + Prismaï¼Œæä¾› Admin å’Œ App ä¸¤å¥— API |
| **ç®¡ç†åå° Web** | `web/` | âœ… å·²å®Œæˆ | Vue 3 + shadcn-vueï¼Œç®¡ç†ç«¯å‰ç«¯ |
| **App ç«¯** | - | â³ æœªå¼€å§‹ | Flutter ç§»åŠ¨ç«¯ï¼Œå¾…å¼€å‘ |

---

## âœ… å·²å®ç°åŠŸèƒ½æ¸…å•

### åç«¯ APIï¼ˆserver-nestjsï¼‰

| åŠŸèƒ½ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| Winston æ—¥å¿—ç³»ç»Ÿ | âœ… | æ”¯æŒæ—¥å¿—åˆ†çº§ã€æ–‡ä»¶è½®è½¬ã€ç”Ÿäº§ç¯å¢ƒ JSON æ ¼å¼ |
| HTTP è¯·æ±‚æ—¥å¿— | âœ… | `HttpLoggerMiddleware` è®°å½•è¯·æ±‚è¯¦æƒ…å’Œè€—æ—¶ |
| ç»Ÿä¸€å¼‚å¸¸å¤„ç† | âœ… | `AllExceptionsFilter` + `BusinessException` |
| é”™è¯¯ç ä½“ç³» | âœ… | `ErrorCode` æšä¸¾ + æ¶ˆæ¯æ˜ å°„ |
| XSS é˜²æŠ¤ | âœ… | `sanitize-html` å·¥å…·å‡½æ•° |
| è´¦æˆ·é”å®šæœºåˆ¶ | âœ… | `SecurityConfigService` ç™»å½•å¤±è´¥æ¬¡æ•°é™åˆ¶ |
| Redis æœåŠ¡ | âœ… | æ”¯æŒçœŸå® Redis å’Œå†…å­˜æ¨¡å¼é™çº§ |
| å‚æ•°æ ¡éªŒ | âœ… | `ValidationPipe` + class-validator |
| CORS é…ç½® | âœ… | ç”Ÿäº§ç¯å¢ƒç™½åå•æ§åˆ¶ |
| Swagger æ–‡æ¡£ | âœ… | Swagger UI + Redoc åŒæ–‡æ¡£ |
| æœåŠ¡å™¨ç›‘æ§ | âœ… | CPU/å†…å­˜/ç£ç›˜ç›‘æ§ |
| æ•°æ®åº“ç›‘æ§ | âœ… | è¿æ¥çŠ¶æ€ç›‘æ§ |
| ç¼“å­˜ç›‘æ§ | âœ… | Redis çŠ¶æ€ç›‘æ§ |
| å®šæ—¶ä»»åŠ¡ | âœ… | `@nestjs/schedule` æ”¯æŒ |
| æ–‡ä»¶ä¸Šä¼  | âœ… | æœ¬åœ° + S3 å­˜å‚¨ |
| é‚®ä»¶æœåŠ¡ | âœ… | Nodemailer é›†æˆ |
| Excel å¯¼å‡º | âœ… | ExcelJS é›†æˆ |

### ç®¡ç†åå° Webï¼ˆwebï¼‰

| åŠŸèƒ½ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| Vue 3 + TypeScript | âœ… | ç°ä»£å‰ç«¯æŠ€æœ¯æ ˆ |
| shadcn-vue ç»„ä»¶åº“ | âœ… | é«˜è´¨é‡ UI ç»„ä»¶ |
| Vite æ„å»º | âœ… | å¿«é€Ÿå¼€å‘ä½“éªŒ |
| è·¯ç”±æ‡’åŠ è½½ | âœ… | Vite é»˜è®¤æ”¯æŒ |
| Pinia çŠ¶æ€ç®¡ç† | âœ… | ç±»å‹å®‰å…¨çš„çŠ¶æ€ç®¡ç† |
| è¡¨å•æ ¡éªŒ | âœ… | vee-validate + zod |
| å¯Œæ–‡æœ¬ç¼–è¾‘å™¨ | âœ… | Tiptap é›†æˆ |

---

## ğŸ“Š ä¼˜åŒ–é¡¹æ€»è§ˆ

| åˆ†ç±» | åç«¯ API | ç®¡ç†åå° Web | App ç«¯ |
|------|----------|--------------|--------|
| é«˜ä¼˜å…ˆçº§ | 5 | 0 | - |
| ä¸­ä¼˜å…ˆçº§ | 5 | 1 | - |
| ä½ä¼˜å…ˆçº§ | 3 | 1 | - |

> **æ³¨:** App ç«¯å°šæœªå¼€å§‹å¼€å‘ï¼Œå¾…å¯åŠ¨åè¡¥å……ä¼˜åŒ–å»ºè®®

---

## ğŸ”´ é«˜ä¼˜å…ˆçº§

### åç«¯ API

#### 1. æ·»åŠ  Rate Limitingï¼ˆæ¥å£é™æµï¼‰

**é—®é¢˜:** ç™»å½•ã€éªŒè¯ç ç­‰æ•æ„Ÿæ¥å£æ—  IP çº§åˆ«é™æµä¿æŠ¤ï¼Œå­˜åœ¨æš´åŠ›ç ´è§£å’ŒçŸ­ä¿¡è½°ç‚¸é£é™©ã€‚

**å½±å“èŒƒå›´:** Admin API + App API

**ç°çŠ¶åˆ†æ:**
- âœ… å·²æœ‰è´¦æˆ·é”å®šæœºåˆ¶ï¼ˆ`SecurityConfigService`ï¼‰
- âŒ ç¼ºå°‘ IP çº§åˆ«çš„è¯·æ±‚é¢‘ç‡é™åˆ¶
- âŒ App ç«¯ SMS éªŒè¯ç æ¥å£æ— é˜²åˆ·ä¿æŠ¤

**å»ºè®®æ–¹æ¡ˆ:**
```bash
pnpm add @nestjs/throttler
```

```typescript
// app.module.ts
import { ThrottlerModule, ThrottlerGuard } from '@nestjs/throttler';

@Module({
  imports: [
    ThrottlerModule.forRoot([
      { name: 'short', ttl: 1000, limit: 3 },      // 1ç§’3æ¬¡
      { name: 'medium', ttl: 10000, limit: 20 },   // 10ç§’20æ¬¡
      { name: 'long', ttl: 60000, limit: 100 },    // 1åˆ†é’Ÿ100æ¬¡
    ]),
  ],
  providers: [
    { provide: APP_GUARD, useClass: ThrottlerGuard },
  ],
})
```

```typescript
// app-auth.controller.ts - SMS éªŒè¯ç é™æµ
@Throttle({ short: { limit: 1, ttl: 60000 } }) // 1åˆ†é’Ÿæœ€å¤š1æ¬¡
@Post('sms/send')
async sendSmsCode(@Body() dto: SendSmsDto) {}

// auth.controller.ts - Admin ç™»å½•é™æµ
@Throttle({ short: { limit: 5, ttl: 60000 } }) // 1åˆ†é’Ÿæœ€å¤š5æ¬¡
@Post('login')
async login(@Body() dto: LoginDto) {}
```

**å·¥ä½œé‡:** çº¦ 2 å°æ—¶

---

#### 2. æ·»åŠ  Helmet å®‰å…¨å“åº”å¤´

**é—®é¢˜:** ç¼ºå°‘å¸¸è§çš„å®‰å…¨å“åº”å¤´ï¼Œå¯èƒ½å—åˆ° XSSã€ç‚¹å‡»åŠ«æŒç­‰æ”»å‡»ã€‚

**å½±å“èŒƒå›´:** Admin API + App API

**å»ºè®®æ–¹æ¡ˆ:**
```bash
pnpm add helmet
```

```typescript
// main.ts
import helmet from 'helmet';

async function bootstrap() {
  const app = await NestFactory.create(AppModule);
  
  app.use(helmet({
    contentSecurityPolicy: {
      directives: {
        defaultSrc: ["'self'"],
        styleSrc: ["'self'", "'unsafe-inline'"],
        imgSrc: ["'self'", 'data:', 'https:'],
        scriptSrc: ["'self'"],
      },
    },
    crossOriginEmbedderPolicy: false,
  }));
}
```

**å·¥ä½œé‡:** çº¦ 30 åˆ†é’Ÿ

---

#### 3. æ·»åŠ  Response å‹ç¼©

**é—®é¢˜:** API å“åº”æœªå‹ç¼©ï¼Œå¢åŠ ç½‘ç»œä¼ è¾“æ—¶é—´ã€‚

**å½±å“èŒƒå›´:** Admin API + App API

**å»ºè®®æ–¹æ¡ˆ:**
```bash
pnpm add compression @types/compression
```

```typescript
// main.ts
import compression from 'compression';

async function bootstrap() {
  const app = await NestFactory.create(AppModule);
  
  app.use(compression({
    threshold: 1024, // åªå‹ç¼©å¤§äº 1KB çš„å“åº”
    level: 6,
  }));
}
```

**æ•ˆæœ:** JSON å“åº”ä½“ç§¯é€šå¸¸å¯å‡å°‘ 60-80%

**å·¥ä½œé‡:** çº¦ 15 åˆ†é’Ÿ

---

#### 4. æ·»åŠ å¥åº·æ£€æŸ¥ç«¯ç‚¹

**é—®é¢˜:** ç¼ºå°‘æ ‡å‡†å¥åº·æ£€æŸ¥ç«¯ç‚¹ï¼Œä¸åˆ©äºå®¹å™¨ç¼–æ’å’Œè´Ÿè½½å‡è¡¡ã€‚

**å½±å“èŒƒå›´:** éƒ¨ç½²è¿ç»´

**ç°çŠ¶åˆ†æ:**
- âœ… å·²æœ‰æœåŠ¡å™¨ç›‘æ§ï¼ˆ`/api/monitor/server`ï¼‰
- âŒ éœ€è¦ç®¡ç†å‘˜æƒé™ï¼Œä¸é€‚åˆ K8s/Docker å¥åº·æ£€æŸ¥
- âŒ ç¼ºå°‘ liveness/readiness åˆ†ç¦»

**å»ºè®®æ–¹æ¡ˆ:**
```bash
pnpm add @nestjs/terminus
```

```typescript
// health/health.controller.ts
@Controller('health')
export class HealthController {
  constructor(
    private health: HealthCheckService,
    private memory: MemoryHealthIndicator,
    private prisma: PrismaHealthIndicator,
  ) {}

  @Get()
  @HealthCheck()
  check() {
    return this.health.check([
      () => this.prisma.isHealthy('database'),
      () => this.memory.checkHeap('memory_heap', 500 * 1024 * 1024),
    ]);
  }

  @Get('liveness')
  liveness() {
    return { status: 'ok' };
  }

  @Get('readiness')
  @HealthCheck()
  readiness() {
    return this.health.check([
      () => this.prisma.isHealthy('database'),
    ]);
  }
}
```

**å·¥ä½œé‡:** çº¦ 1.5 å°æ—¶

---

#### 5. Graceful Shutdown

**é—®é¢˜:** æœåŠ¡é‡å¯æ—¶å¯èƒ½ä¸­æ–­æ­£åœ¨å¤„ç†çš„è¯·æ±‚ã€‚

**å½±å“èŒƒå›´:** éƒ¨ç½²è¿ç»´

**å»ºè®®æ–¹æ¡ˆ:**

```typescript
// main.ts
async function bootstrap() {
  const app = await NestFactory.create(AppModule);
  
  app.enableShutdownHooks();
  
  const logger = app.get(LoggerService);
  
  process.on('SIGTERM', async () => {
    logger.log('æ”¶åˆ° SIGTERM ä¿¡å·ï¼Œå¼€å§‹ä¼˜é›…å…³é—­...', 'Bootstrap');
    await app.close();
    process.exit(0);
  });
  
  process.on('SIGINT', async () => {
    logger.log('æ”¶åˆ° SIGINT ä¿¡å·ï¼Œå¼€å§‹ä¼˜é›…å…³é—­...', 'Bootstrap');
    await app.close();
    process.exit(0);
  });
}
```

**å·¥ä½œé‡:** çº¦ 30 åˆ†é’Ÿ

---

## ğŸŸ¡ ä¸­ä¼˜å…ˆçº§

### åç«¯ API

#### 6. Service å±‚äº‹åŠ¡å¤„ç†

**é—®é¢˜:** éƒ¨åˆ†æ¶‰åŠå¤šè¡¨æ“ä½œçš„æ–¹æ³•æœªä½¿ç”¨äº‹åŠ¡ï¼Œå¯èƒ½å¯¼è‡´æ•°æ®ä¸ä¸€è‡´ã€‚

**å½±å“èŒƒå›´:** App APIï¼ˆæ–‡åŒ–ä¹‹æ—…ã€å°è®°ç›¸å…³ï¼‰

**ç°çŠ¶åˆ†æ:**
```typescript
// journey.service.ts - startJourney æ–¹æ³•
// åˆ›å»ºè¿›åº¦ + è®°å½•åŠ¨æ€ï¼Œä¸¤ä¸ªæ“ä½œæœªåœ¨äº‹åŠ¡ä¸­
const progress = await this.prisma.journeyProgress.create({ ... });
await this.prisma.userActivity.create({ ... });
```

**å»ºè®®æ–¹æ¡ˆ:**
```typescript
async startJourney(userId: string, journeyId: string) {
  return this.prisma.$transaction(async (tx) => {
    const journey = await tx.journey.findUnique({ where: { id: journeyId } });
    if (!journey || journey.status !== '0') {
      throw new BusinessException(ErrorCode.DATA_NOT_FOUND, 'æ–‡åŒ–ä¹‹æ—…ä¸å­˜åœ¨');
    }

    const progress = await tx.journeyProgress.create({
      data: { userId, journeyId, status: 'in_progress', startTime: new Date() },
    });

    await tx.userActivity.create({
      data: {
        userId,
        type: 'journey_started',
        title: `å¼€å§‹äº†ã€Œ${journey.name}ã€æ–‡åŒ–ä¹‹æ—…`,
        relatedId: journeyId,
      },
    });

    return { progressId: progress.id, journeyId, startTime: progress.startTime };
  });
}
```

**é€‚ç”¨åœºæ™¯:**
- å¼€å§‹/å®Œæˆæ–‡åŒ–ä¹‹æ—…
- è·å¾—å°è®°
- ç”¨æˆ·æ³¨å†Œï¼ˆåˆ›å»ºç”¨æˆ· + åˆå§‹åŒ–æ•°æ®ï¼‰

**å·¥ä½œé‡:** çº¦ 2 å°æ—¶

---

#### 7. æ·»åŠ è¯·æ±‚è¿½è¸ª ID

**é—®é¢˜:** æ—¥å¿—ç¼ºå°‘è¯·æ±‚è¿½è¸ª IDï¼Œéš¾ä»¥å…³è”åŒä¸€è¯·æ±‚çš„å¤šæ¡æ—¥å¿—ã€‚

**å½±å“èŒƒå›´:** Admin API + App API

**å»ºè®®æ–¹æ¡ˆ:**

```typescript
// common/middleware/request-id.middleware.ts
import { Injectable, NestMiddleware } from '@nestjs/common';
import { Request, Response, NextFunction } from 'express';
import { randomUUID } from 'crypto';

declare global {
  namespace Express {
    interface Request {
      requestId: string;
    }
  }
}

@Injectable()
export class RequestIdMiddleware implements NestMiddleware {
  use(req: Request, res: Response, next: NextFunction) {
    const requestId = (req.headers['x-request-id'] as string) || randomUUID();
    req.requestId = requestId;
    res.setHeader('X-Request-ID', requestId);
    next();
  }
}
```

**å·¥ä½œé‡:** çº¦ 1 å°æ—¶

---

#### 8. æ•æ„Ÿæ•°æ®è„±æ•

**é—®é¢˜:** æ—¥å¿—å’Œ API å“åº”ä¸­å¯èƒ½æš´éœ²æ•æ„Ÿä¿¡æ¯ã€‚

**å½±å“èŒƒå›´:** Admin API + App API

**å»ºè®®æ–¹æ¡ˆ:**

```typescript
// common/utils/desensitize.util.ts
export class DesensitizeUtil {
  /** æ‰‹æœºå·è„±æ•: 138****1234 */
  static phone(phone: string): string {
    if (!phone || phone.length < 7) return phone;
    return phone.replace(/(\d{3})\d{4}(\d+)/, '$1****$2');
  }

  /** é‚®ç®±è„±æ•: a***@example.com */
  static email(email: string): string {
    if (!email) return email;
    const [name, domain] = email.split('@');
    if (!domain) return email;
    return `${name[0]}***@${domain}`;
  }

  /** è¯·æ±‚å‚æ•°è„±æ•ï¼ˆç”¨äºæ—¥å¿—ï¼‰ */
  static sanitizeParams(params: Record<string, unknown>): Record<string, unknown> {
    const sensitiveKeys = ['password', 'token', 'secret', 'code', 'smsCode'];
    const result = { ...params };
    
    for (const key of Object.keys(result)) {
      if (sensitiveKeys.some(sk => key.toLowerCase().includes(sk))) {
        result[key] = '******';
      }
    }
    return result;
  }
}
```

**å·¥ä½œé‡:** çº¦ 2 å°æ—¶

---

#### 9. æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ– - ä½¿ç”¨ select

**é—®é¢˜:** éƒ¨åˆ†æŸ¥è¯¢è¿”å›äº†ä¸å¿…è¦çš„å­—æ®µï¼Œå¢åŠ æ•°æ®ä¼ è¾“é‡ã€‚

**å½±å“èŒƒå›´:** App APIï¼ˆåˆ—è¡¨æŸ¥è¯¢ï¼‰

**å»ºè®®æ–¹æ¡ˆ:**
```typescript
// ä¼˜åŒ–å‰
const cities = await this.prisma.city.findMany({
  where: { status: '0' },
});

// ä¼˜åŒ–å - åªè¿”å›éœ€è¦çš„å­—æ®µ
const cities = await this.prisma.city.findMany({
  where: { status: '0' },
  select: {
    id: true,
    name: true,
    province: true,
    latitude: true,
    longitude: true,
    iconAsset: true,
    coverImage: true,
    description: true,
    explorerCount: true,
    bgmUrl: true,
  },
  orderBy: { orderNum: 'asc' },
});
```

**å·¥ä½œé‡:** çº¦ 3 å°æ—¶

---

#### 10. æ·»åŠ  Redis ç¼“å­˜å±‚

**é—®é¢˜:** å­—å…¸æ•°æ®ã€åŸå¸‚åˆ—è¡¨ç­‰å˜åŒ–ä¸é¢‘ç¹çš„æ•°æ®æ¯æ¬¡éƒ½æŸ¥æ•°æ®åº“ã€‚

**å½±å“èŒƒå›´:** Admin API + App API

**å»ºè®®æ–¹æ¡ˆ:**

```typescript
// common/cache/cache.service.ts
@Injectable()
export class CacheService {
  private readonly DEFAULT_TTL = 300; // 5åˆ†é’Ÿ

  constructor(private redis: RedisService) {}

  async getOrSet<T>(key: string, factory: () => Promise<T>, ttl = this.DEFAULT_TTL): Promise<T> {
    const client = this.redis.getClient();
    const cached = await client.get(key);
    if (cached) return JSON.parse(cached) as T;

    const data = await factory();
    await client.setex(key, ttl, JSON.stringify(data));
    return data;
  }
}

// ä½¿ç”¨ç¤ºä¾‹ - city.service.ts
async findAll(query: QueryCityDto) {
  const cacheKey = `cities:list:${query.province || 'all'}`;
  
  return this.cacheService.getOrSet(cacheKey, async () => {
    return this.prisma.city.findMany({ ... });
  }, 600);
}
```

**é€‚ç”¨æ•°æ®:**
- å­—å…¸æ•°æ®ï¼ˆ`sys_dict_data`ï¼‰
- åŸå¸‚åˆ—è¡¨
- ç³»ç»Ÿé…ç½®ï¼ˆ`sys_config`ï¼‰

**å·¥ä½œé‡:** çº¦ 4 å°æ—¶

---

### ç®¡ç†åå° Web

#### 11. API è¯·æ±‚å–æ¶ˆï¼ˆé˜²é‡å¤æäº¤ï¼‰

**é—®é¢˜:** å¿«é€Ÿç‚¹å‡»å¯èƒ½å¯¼è‡´é‡å¤è¯·æ±‚ã€‚

**å½±å“èŒƒå›´:** ç®¡ç†åå° Web

**å»ºè®®æ–¹æ¡ˆ:**

```typescript
// utils/request.ts
const pendingRequests = new Map<string, AbortController>();

service.interceptors.request.use((config) => {
  const requestKey = `${config.method}:${config.url}`;
  
  // å–æ¶ˆé‡å¤è¯·æ±‚
  if (pendingRequests.has(requestKey)) {
    pendingRequests.get(requestKey)?.abort();
  }
  
  const controller = new AbortController();
  config.signal = controller.signal;
  pendingRequests.set(requestKey, controller);
  
  return config;
});

service.interceptors.response.use((response) => {
  const requestKey = `${response.config.method}:${response.config.url}`;
  pendingRequests.delete(requestKey);
  return response;
});
```

**å·¥ä½œé‡:** çº¦ 1 å°æ—¶

---

## ğŸŸ¢ ä½ä¼˜å…ˆçº§

### åç«¯ API

#### 12. ç¯å¢ƒå˜é‡æ ¡éªŒ

**é—®é¢˜:** å¯åŠ¨æ—¶ä¸æ£€æŸ¥å¿…è¦ç¯å¢ƒå˜é‡ï¼Œå¯èƒ½å¯¼è‡´è¿è¡Œæ—¶é”™è¯¯ã€‚

**å½±å“èŒƒå›´:** éƒ¨ç½²è¿ç»´

**å»ºè®®æ–¹æ¡ˆ:**

```typescript
// config/env.validation.ts
import { plainToInstance } from 'class-transformer';
import { IsString, IsNumber, IsOptional, validateSync, IsIn } from 'class-validator';

class EnvironmentVariables {
  @IsNumber()
  PORT: number = 3000;

  @IsIn(['development', 'production', 'test'])
  NODE_ENV: string = 'development';

  @IsString()
  DATABASE_URL: string;

  @IsString()
  JWT_SECRET: string;

  @IsOptional()
  @IsString()
  REDIS_URL?: string;
}

export function validate(config: Record<string, unknown>) {
  const validatedConfig = plainToInstance(EnvironmentVariables, config, {
    enableImplicitConversion: true,
  });
  
  const errors = validateSync(validatedConfig, { skipMissingProperties: false });

  if (errors.length > 0) {
    throw new Error(`ç¯å¢ƒå˜é‡æ ¡éªŒå¤±è´¥:\n${errors.map(e => Object.values(e.constraints || {})).join('\n')}`);
  }
  
  return validatedConfig;
}
```

**å·¥ä½œé‡:** çº¦ 1 å°æ—¶

---

#### 13. Docker é•œåƒä¼˜åŒ–

**é—®é¢˜:** å½“å‰é•œåƒè¾ƒå¤§ï¼Œå¯ä»¥è¿›ä¸€æ­¥ä¼˜åŒ–ã€‚

**å½±å“èŒƒå›´:** éƒ¨ç½²è¿ç»´

**å»ºè®®æ–¹æ¡ˆ:**

```dockerfile
# å¤šé˜¶æ®µæ„å»ºä¼˜åŒ–
FROM node:20-alpine AS builder
WORKDIR /app
COPY package.json pnpm-lock.yaml ./
RUN corepack enable && pnpm install --frozen-lockfile
COPY . .
RUN pnpm build && pnpm prune --prod

FROM node:20-alpine AS runner
WORKDIR /app
COPY --from=builder /app/dist ./dist
COPY --from=builder /app/node_modules ./node_modules
COPY --from=builder /app/package.json ./
COPY --from=builder /app/prisma ./prisma

RUN addgroup -g 1001 -S nodejs && adduser -S nestjs -u 1001
USER nestjs

EXPOSE 3000
CMD ["node", "dist/src/main.js"]
```

**æ•ˆæœ:** é•œåƒä½“ç§¯å¯å‡å°‘ 30-50%

**å·¥ä½œé‡:** çº¦ 1 å°æ—¶

---

#### 14. å›¾ç‰‡å¤„ç†ä¼˜åŒ–

**é—®é¢˜:** ä¸Šä¼ çš„å›¾ç‰‡æœªè¿›è¡Œå‹ç¼©å’Œæ ¼å¼è½¬æ¢ã€‚

**å½±å“èŒƒå›´:** Admin APIï¼ˆæ–‡ä»¶ä¸Šä¼ ï¼‰

**å»ºè®®æ–¹æ¡ˆ:**
```bash
pnpm add sharp
```

```typescript
// common/upload/image.service.ts
import sharp from 'sharp';

@Injectable()
export class ImageService {
  async processImage(buffer: Buffer, options: {
    width?: number;
    quality?: number;
    format?: 'jpeg' | 'webp' | 'png';
  } = {}): Promise<Buffer> {
    const { width = 1920, quality = 80, format = 'webp' } = options;
    
    return sharp(buffer)
      .resize(width, undefined, { fit: 'inside', withoutEnlargement: true })
      [format]({ quality })
      .toBuffer();
  }
}
```

**å·¥ä½œé‡:** çº¦ 3 å°æ—¶

---

### ç®¡ç†åå° Web

#### 15. å¤§å‹ç»„ä»¶æŒ‰éœ€åŠ è½½

**é—®é¢˜:** å¯Œæ–‡æœ¬ç¼–è¾‘å™¨ç­‰å¤§å‹ç»„ä»¶å¯æŒ‰éœ€åŠ è½½ã€‚

**å½±å“èŒƒå›´:** ç®¡ç†åå° Web

**å»ºè®®æ–¹æ¡ˆ:**

```typescript
// å¯Œæ–‡æœ¬ç¼–è¾‘å™¨æŒ‰éœ€åŠ è½½
const TiptapEditor = defineAsyncComponent(() => 
  import('@/components/TiptapEditor.vue')
);

// Excel å¯¼å‡ºæŒ‰éœ€åŠ è½½
const exportToExcel = async (data: unknown[]) => {
  const XLSX = await import('xlsx');
  // ...
};
```

**å·¥ä½œé‡:** çº¦ 1 å°æ—¶

---

## ğŸ“‹ å®æ–½å»ºè®®

### æŒ‰ç«¯åˆ†ç±»çš„å®æ–½é¡ºåº

#### åç«¯ APIï¼ˆç¬¬ä¸€ä¼˜å…ˆï¼‰

| é˜¶æ®µ | ä¼˜åŒ–é¡¹ | å·¥æ—¶ | æ”¶ç›Š |
|------|--------|------|------|
| **ç«‹å³** | Helmet | 0.5h | å®‰å…¨æ€§ |
| **ç«‹å³** | Response å‹ç¼© | 0.5h | æ€§èƒ½ |
| **ç«‹å³** | Graceful Shutdown | 0.5h | ç¨³å®šæ€§ |
| **æœ¬å‘¨** | Rate Limiting | 2h | å®‰å…¨æ€§ |
| **æœ¬å‘¨** | å¥åº·æ£€æŸ¥ç«¯ç‚¹ | 1.5h | è¿ç»´ |
| **ä¸‹å‘¨** | è¯·æ±‚è¿½è¸ª ID | 1h | å¯è§‚æµ‹æ€§ |
| **ä¸‹å‘¨** | äº‹åŠ¡å¤„ç†å®Œå–„ | 2h | æ•°æ®ä¸€è‡´æ€§ |

#### ç®¡ç†åå° Webï¼ˆç¬¬äºŒä¼˜å…ˆï¼‰

| é˜¶æ®µ | ä¼˜åŒ–é¡¹ | å·¥æ—¶ | æ”¶ç›Š |
|------|--------|------|------|
| **ä¸‹å‘¨** | API è¯·æ±‚å–æ¶ˆ | 1h | ç”¨æˆ·ä½“éªŒ |
| **åç»­** | å¤§å‹ç»„ä»¶æŒ‰éœ€åŠ è½½ | 1h | æ€§èƒ½ |

#### App ç«¯ï¼ˆå¾…å¯åŠ¨ï¼‰

> App ç«¯ä½¿ç”¨ Flutter å¼€å‘ï¼Œå¾…é¡¹ç›®å¯åŠ¨åè¡¥å……ä¼˜åŒ–å»ºè®®ï¼Œé¢„è®¡åŒ…æ‹¬ï¼š
> - ç½‘ç»œè¯·æ±‚å°è£…ä¸é”™è¯¯å¤„ç†
> - æœ¬åœ°ç¼“å­˜ç­–ç•¥
> - å›¾ç‰‡åŠ è½½ä¼˜åŒ–
> - ç¦»çº¿æ¨¡å¼æ”¯æŒ
> - æ€§èƒ½ç›‘æ§åŸ‹ç‚¹

---

## ğŸ“š å‚è€ƒèµ„æº

- [NestJS å®˜æ–¹æ–‡æ¡£](https://docs.nestjs.com/)
- [Prisma æ€§èƒ½ä¼˜åŒ–æŒ‡å—](https://www.prisma.io/docs/guides/performance-and-optimization)
- [OWASP å®‰å…¨æœ€ä½³å®è·µ](https://owasp.org/www-project-web-security-testing-guide/)

---

**æ–‡æ¡£ç»´æŠ¤è€…:** å¼€å‘å›¢é˜Ÿ  
**æœ€åæ›´æ–°:** 2025-12-31

# 印记上链技术方案

## 一、需求背景

将用户获得的印记数据进行存证，实现：
- 数据不可篡改
- 可追溯验证
- 增强用户信任感和收藏价值

## 二、方案对比

| 方案 | 成本 | 实现难度 | 合规性 | 去中心化 | 适用场景 |
|------|------|----------|--------|----------|----------|
| 蚂蚁链开放联盟链 | 低 | 中 | ✅ 高 | 联盟链 | 正式上线 |
| BSN 开放联盟链 | 低 | 中 | ✅ 高 | 联盟链 | 正式上线 |
| 腾讯至信链 | 中 | 中 | ✅ 高 | 联盟链 | 正式上线 |
| 时间戳存证 | 低 | 低 | ✅ 高 | 中心化 | 法律存证 |
| 本地哈希存证 | 免费 | 低 | ❌ 无 | 无 | MVP/演示 |
| 公链(Polygon) | 极低 | 高 | ⚠️ 存疑 | 完全去中心化 | 海外项目 |

## 三、推荐方案详解

### 方案 A：蚂蚁链开放联盟链（推荐）

#### 优势
- 国内合规，蚂蚁集团背书
- 有免费额度（每月 1000 次）
- SDK 完善，文档齐全
- 支持存证、溯源、验真

#### 费用
- 免费额度：1000 次/月
- 超出部分：约 0.1-0.5 元/次

#### 接入流程
1. 注册蚂蚁链开放平台账号
2. 创建应用，获取 AppID 和密钥
3. 集成 SDK，调用存证 API
4. 获取链上交易哈希和区块信息

---

### 方案 B：BSN 开放联盟链

#### 优势
- 国家信息中心主导，政府背书
- 支持多条国产链（文昌链、泰安链等）
- 价格透明，按量计费

#### 费用
- 存证：约 0.05-0.2 元/次
- 查询：免费

#### 接入流程
1. 注册 BSN 门户账号
2. 选择链（推荐文昌链-至信链）
3. 创建项目，获取接入凭证
4. 使用 REST API 或 SDK 接入

---

### 方案 C：时间戳存证（轻量方案）

#### 优势
- 实现简单，无需区块链知识
- 有法律效力（符合《电子签名法》）
- 成本低，响应快

#### 费用
- 联合信任时间戳：约 0.1-0.3 元/次
- 批量有优惠

#### 接入流程
1. 申请时间戳服务账号
2. 调用 TSA 接口获取时间戳令牌
3. 存储令牌，支持后续验证

---

### 方案 D：本地哈希存证（MVP 方案）

#### 优势
- 零成本
- 实现最简单
- 适合早期验证产品

#### 局限
- 无第三方背书
- 不具备法律效力
- 仅作为产品功能展示

---

### 方案 E：Polygon 公链（海外方案）

#### 什么是 Polygon？

Polygon（原名 Matic Network）是以太坊的 Layer 2 扩展方案，可以理解为：
- **以太坊的"高速公路"**：继承以太坊的安全性，但交易更快、费用更低
- **真正的公链**：数据存储在全球数千个节点上，任何人都可以验证
- **EVM 兼容**：使用和以太坊相同的技术栈（Solidity、ethers.js）

#### 与联盟链的区别

| 特性 | Polygon（公链） | 蚂蚁链/BSN（联盟链） |
|------|----------------|---------------------|
| 去中心化程度 | 完全去中心化 | 部分去中心化 |
| 节点控制 | 任何人可运行节点 | 联盟成员控制 |
| 数据公开性 | 完全公开透明 | 联盟内可见 |
| 合规性 | 国内存在政策风险 | 国内合规 |
| 费用 | Gas 费（约 0.01 元/笔） | API 调用费 |
| 访问稳定性 | 国内可能不稳定 | 国内稳定 |

#### 优势
- 真正去中心化，数据永久存储，无法被任何单一实体删除
- Gas 费极低（约 0.01 MATIC/笔，折合几分钱人民币）
- 用户可在 [PolygonScan](https://polygonscan.com) 公开验证交易
- 无需企业认证，个人即可使用
- 全球通用，无地域限制

#### 局限
- 国内合规风险，政策不确定（虚拟货币相关）
- 需要钱包私钥，有安全风险
- 国内网络访问可能不稳定，需要代理或海外节点
- 需要持有少量 MATIC 代币支付 Gas 费

#### 接入流程
1. 创建以太坊钱包（推荐 MetaMask）
2. 切换到 Polygon 网络
3. 获取少量 MATIC 作为 Gas 费（可在交易所购买后提现）
4. 导出钱包私钥配置到系统
5. 可选：部署存证智能合约

#### 获取 MATIC 的方式
- 中心化交易所（Binance、OKX 等）购买后提现到 Polygon 网络
- 使用跨链桥从以太坊主网转移
- 测试网可使用 [Polygon Faucet](https://faucet.polygon.technology/) 免费获取

#### 适用场景
- 海外用户为主的产品
- 需要真正去中心化存证的场景
- 个人开发者/小团队（无需企业认证）
- 对数据公开透明有要求的场景

---

## 四、实现状态

### 已完成 ✅

| 模块 | 状态 | 说明 |
|------|------|------|
| 策略模式架构 | ✅ 已完成 | 支持通过配置无缝切换链服务 |
| ChainProvider 接口 | ✅ 已完成 | 定义 `chain()` 和 `verify()` 标准方法 |
| LocalChainProvider | ✅ 已完成 | 本地 SHA-256 哈希存证，当前默认使用 |
| TimestampProvider | ✅ 已完成 | 可信时间戳存证（模拟实现，**待对接真实 TSA 服务**） |
| ZhixinChainProvider | ✅ 已完成 | 腾讯至信链存证（模拟实现，**待对接腾讯云 API**） |
| AntChainProvider | ✅ 已完成 | 蚂蚁链存证（模拟实现，**待对接蚂蚁链 SDK**） |
| BSNChainProvider | ✅ 已完成 | BSN 存证（模拟实现，**待对接 BSN API**） |
| PolygonProvider | ✅ 已完成 | Polygon 公链存证（模拟实现，**待对接 ethers.js**） |
| BlockchainConfigService | ✅ 已完成 | 从数据库 `sys_config` 读取链配置 |
| BlockchainController | ✅ 已完成 | App 端 API：上链、验证、查询状态 |
| Swagger 文档 | ✅ 已完成 | API 接口文档化 |

### 待对接 🔧

所有 Provider 均已实现框架代码和模拟逻辑，但真实 API 调用部分标记为 `TODO`，需要：

1. **蚂蚁链** - 对接蚂蚁链 SDK，实现真实存证调用
2. **BSN** - 对接 BSN REST API，实现合约调用
3. **Polygon** - 集成 ethers.js，实现链上交易
4. **时间戳** - 对接可信时间戳服务商（如联合信任 TSA）
5. **至信链** - 对接腾讯云 TBaaS API

---

## 五、代码结构

```
server-nestjs/src/blockchain/
├── interfaces/
│   └── chain-provider.interface.ts   # 链服务接口定义
├── providers/
│   ├── index.ts                      # 导出
│   ├── local-chain.provider.ts       # ✅ 本地哈希存证（当前使用）
│   ├── timestamp.provider.ts         # 🔧 时间戳存证（待对接真实 TSA）
│   ├── antchain.provider.ts          # 🔧 蚂蚁链（待对接 SDK）
│   ├── zhixin-chain.provider.ts      # 🔧 腾讯至信链（待对接 API）
│   ├── bsn-chain.provider.ts         # 🔧 BSN（待对接 API）
│   └── polygon.provider.ts           # 🔧 Polygon 公链（待对接 ethers.js）
├── dto/
│   └── chain-seal.dto.ts             # 响应 DTO（ChainSealVo、VerifyChainVo、ChainStatusVo）
├── blockchain-config.service.ts      # 从数据库读取配置
├── blockchain.controller.ts          # API 控制器
├── blockchain.service.ts             # 业务逻辑
└── blockchain.module.ts              # 模块配置（策略模式切换）
```

---

## 六、API 接口

### App 端接口

| 方法 | 路径 | 说明 | 认证 |
|------|------|------|------|
| POST | `/api/app/blockchain/chain/:sealId` | 印记上链 | 需要登录 |
| GET | `/api/app/blockchain/verify/:txHash` | 验证链上记录 | 无需登录 |
| GET | `/api/app/blockchain/status/:sealId` | 查询上链状态 | 需要登录 |

### 响应示例

**上链成功**
```json
{
  "code": 200,
  "msg": "success",
  "data": {
    "sealId": "seal_001",
    "txHash": "0x1234567890abcdef...",
    "blockHeight": "12345678",
    "chainTime": "2025-01-04T10:30:00.000Z",
    "chainName": "LocalChain"
  }
}
```

**验证结果**
```json
{
  "code": 200,
  "msg": "success",
  "data": {
    "valid": true,
    "txHash": "0x1234567890abcdef...",
    "blockHeight": "12345678",
    "chainTime": "2025-01-04T10:30:00.000Z",
    "chainName": "LocalChain",
    "sealName": "西湖印记",
    "ownerNickname": "用户昵称",
    "earnedTime": "2025-01-04T09:00:00.000Z"
  }
}
```

---

## 七、配置说明

### 切换链服务

在管理后台「系统管理 → 系统设置 → 区块链存证」中配置，或直接修改 `sys_config` 表：

| 配置项 | 说明 |
|--------|------|
| `chain.provider` | 链服务提供者：`local` / `timestamp` / `antchain` / `zhixin` / `bsn` / `polygon` |

### 各链服务配置

**蚂蚁链**
| 配置项 | 说明 |
|--------|------|
| `chain.antchain.appId` | 蚂蚁链 App ID |
| `chain.antchain.privateKey` | 蚂蚁链私钥 |
| `chain.antchain.endpoint` | API 端点（默认：`https://rest.antchain.alipay.com`） |

**BSN**
| 配置项 | 说明 |
|--------|------|
| `chain.bsn.apiKey` | BSN API Key |
| `chain.bsn.projectId` | BSN 项目 ID |
| `chain.bsn.endpoint` | API 端点（默认：`https://api.bsngate.com`） |

**Polygon**
| 配置项 | 说明 |
|--------|------|
| `chain.polygon.rpcUrl` | RPC URL（默认：`https://polygon-rpc.com`） |
| `chain.polygon.privateKey` | 钱包私钥 |
| `chain.polygon.contractAddress` | 合约地址（可选） |

**时间戳**
| 配置项 | 说明 |
|--------|------|
| `chain.timestamp.apiKey` | 时间戳服务 API Key |
| `chain.timestamp.endpoint` | TSA 服务端点 |

**至信链**
| 配置项 | 说明 |
|--------|------|
| `chain.zhixin.secretId` | 腾讯云 SecretId |
| `chain.zhixin.secretKey` | 腾讯云 SecretKey |
| `chain.zhixin.endpoint` | API 端点（默认：`https://tbaas.tencentcloudapi.com`） |

修改配置后重启服务生效。

---

## 八、数据库设计

`user_seal` 表相关字段：

```prisma
model UserSeal {
  // ... 现有字段
  
  isChained        Boolean   @default(false)  // 是否已上链
  chainName        String?                    // 链名称：LocalChain / AntChain / BSN / Polygon / Timestamp / ZhixinChain
  txHash           String?                    // 交易哈希
  blockHeight      BigInt?                    // 区块高度
  chainTime        DateTime?                  // 上链时间
  chainCertificate Json?                      // 存证原始数据（用于验证）
}
```

---

## 九、实施建议

### 阶段一：MVP（✅ 已完成）
- ✅ 使用方案 D（本地哈希存证）
- ✅ 实现策略模式，支持无缝切换
- ✅ 完成所有 Provider 框架代码
- ✅ API 接口开发完成

### 阶段二：正式上线（1-2 周）
- 选择方案 A（蚂蚁链）或方案 B（BSN）
- 申请账号，完成企业认证
- 在对应 provider 文件中补充真实 API 调用（替换 TODO 部分）
- 增加异步上链队列（避免阻塞用户操作）

### 阶段三：优化（持续）
- 增加批量上链（降低成本）
- 增加上链失败重试机制
- 开发链上证书查询页面

---

## 十、成本估算

假设月活用户 1 万，平均每人上链 5 个印记：

| 方案 | 月调用量 | 单价 | 月成本 |
|------|----------|------|--------|
| 蚂蚁链 | 50,000 | 0.1 元 | ~4,900 元（扣除免费额度） |
| BSN | 50,000 | 0.05 元 | ~2,500 元 |
| 时间戳 | 50,000 | 0.1 元 | ~5,000 元 |
| Polygon | 50,000 | ~0.01 元 | ~500 元 |
| 本地存证 | 50,000 | 0 | 0 元 |

---

## 十一、总结

| 场景 | 推荐方案 |
|------|----------|
| 快速上线/预算有限 | 方案 D（本地存证）→ 后续升级 |
| 正式商用/需要背书 | 方案 A（蚂蚁链）或 方案 B（BSN） |
| 需要法律效力 | 方案 C（时间戳）+ 方案 A/B |
| 海外用户/去中心化 | 方案 E（Polygon） |

当前已实现本地存证方案，后续升级只需：
1. 在管理后台切换 `chain.provider` 配置
2. 填写对应链服务的密钥信息
3. 在 Provider 代码中完成真实 API 对接（替换 TODO）
4. 重启服务

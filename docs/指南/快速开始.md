# RBAC Admin Pro éƒ¨ç½²æŒ‡å—

## ç›®å½•

- [ç¯å¢ƒè¦æ±‚](#ç¯å¢ƒè¦æ±‚)
- [æœ¬åœ°å¼€å‘](#æœ¬åœ°å¼€å‘)
- [Docker éƒ¨ç½²](#docker-éƒ¨ç½²)
- [æ‰‹åŠ¨éƒ¨ç½²ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰](#æ‰‹åŠ¨éƒ¨ç½²ç”Ÿäº§ç¯å¢ƒ)
- [ç”Ÿäº§ç¯å¢ƒå®‰å…¨é…ç½®](#ç”Ÿäº§ç¯å¢ƒå®‰å…¨é…ç½®)
- [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)

---

## ç¯å¢ƒè¦æ±‚

| ç»„ä»¶ | ç‰ˆæœ¬è¦æ±‚ | è¯´æ˜ |
|------|----------|------|
| Node.js | >= 20.x | è¿è¡Œæ—¶ |
| pnpm | >= 9.x | åŒ…ç®¡ç†å™¨ |
| PostgreSQL | >= 16 | æ•°æ®åº“ |
| Redis | >= 7 | ç¼“å­˜ï¼ˆå¯é€‰ï¼Œå¼€å‘ç¯å¢ƒå¯è·³è¿‡ï¼‰ |
| Docker | >= 20.x | Docker éƒ¨ç½²æ—¶éœ€è¦ |
| Docker Compose | >= 2.x | Docker éƒ¨ç½²æ—¶éœ€è¦ |

---

## æœ¬åœ°å¼€å‘

é€‚ç”¨äºå¼€å‘è°ƒè¯•åœºæ™¯ã€‚æœ¬åœ°å¼€å‘åªç”¨ Docker è·‘æ•°æ®åº“ï¼Œå‰åç«¯ä»£ç ç›´æ¥æœ¬åœ°è¿è¡Œï¼ˆæ”¯æŒçƒ­é‡è½½ï¼‰ã€‚

### 1. å¯åŠ¨æ•°æ®åº“ï¼ˆDockerï¼‰

```bash
# åªå¯åŠ¨ PostgreSQL + Redisï¼Œä¸å¯åŠ¨åº”ç”¨æœåŠ¡
docker compose up -d postgres redis

# æˆ–ä½¿ç”¨é¡¹ç›®è„šæœ¬
./db.sh start
```

> ğŸ’¡ ä¸è¦ç”¨ `docker compose up -d` å¯åŠ¨å…¨éƒ¨æœåŠ¡ï¼Œé‚£æ ·ä¼šæŠŠå‰åç«¯ä¹Ÿå®¹å™¨åŒ–ï¼Œæ”¹ä»£ç ä¸æ–¹ä¾¿ã€‚

### 2. åˆå§‹åŒ–æ•°æ®åº“

```bash
# æ–¹å¼ä¸€ï¼šä½¿ç”¨ Prismaï¼ˆæ¨èï¼‰
cd server-nestjs
pnpm prisma migrate deploy
pnpm prisma db seed

# æ–¹å¼äºŒï¼šä½¿ç”¨ SQL è„šæœ¬
psql -U rbac_admin -d rbac_admin -f db/schema.sql
psql -U rbac_admin -d rbac_admin -f db/init_data.sql
```

### 3. é…ç½®ç¯å¢ƒå˜é‡

```bash
# åç«¯é…ç½®
cd server-nestjs
cp .env.example .env
# ç¼–è¾‘ .envï¼Œç¡®ä¿ DATABASE_URL æ­£ç¡®
```

### 4. å¯åŠ¨æœåŠ¡

```bash
# åœ¨é¡¹ç›®æ ¹ç›®å½•ï¼ŒåŒæ—¶å¯åŠ¨å‰åç«¯
pnpm dev

# æˆ–åˆ†åˆ«å¯åŠ¨
pnpm dev:web     # å‰ç«¯ http://localhost:5173
pnpm dev:server  # åç«¯ http://localhost:3000
```

### 5. è®¿é—®ç³»ç»Ÿ

| æœåŠ¡ | åœ°å€ |
|------|------|
| å‰ç«¯ | http://localhost:5173 |
| åç«¯ API | http://localhost:3000 |
| API æ–‡æ¡£ | http://localhost:3000/api-docs |

é»˜è®¤è´¦å·ï¼š`admin` / `admin123`

---

## Docker éƒ¨ç½²

### å¿«é€Ÿå¯åŠ¨ï¼ˆæœ¬åœ°æµ‹è¯•ï¼‰

```bash
# å¤åˆ¶ç¯å¢ƒå˜é‡
cp .env.docker.example .env

# ç¼–è¾‘ .envï¼Œä¿®æ”¹å¯†ç å’Œ JWT å¯†é’¥
vim .env

# å¯åŠ¨æ‰€æœ‰æœåŠ¡
docker compose up -d

# æŸ¥çœ‹çŠ¶æ€
docker compose ps
```

### ç”Ÿäº§ç¯å¢ƒ Docker éƒ¨ç½²

å¦‚æœä½¿ç”¨å®å¡”é¢æ¿ï¼Œè¯·å‚è€ƒï¼š[å®å¡” Docker éƒ¨ç½²æŒ‡å—](./å®å¡”Dockeréƒ¨ç½²æŒ‡å—.md)

è¯¥æŒ‡å—åŒ…å«ï¼š
- å®å¡”ç¯å¢ƒå‡†å¤‡
- Docker é•œåƒæ„å»º
- åå‘ä»£ç†é…ç½®
- SSL è¯ä¹¦é…ç½®
- æ•°æ®å¤‡ä»½ç­–ç•¥
- å¸¸è§é—®é¢˜æ’æŸ¥

---

## æ‰‹åŠ¨éƒ¨ç½²ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰

é€‚ç”¨äºä¸ä½¿ç”¨ Dockerã€éœ€è¦æ›´çµæ´»é…ç½®çš„åœºæ™¯ã€‚

### 1. æ•°æ®åº“å‡†å¤‡

#### å®‰è£… PostgreSQL

```bash
# Ubuntu/Debian
sudo apt install postgresql-16
sudo systemctl start postgresql

# CentOS/RHEL
sudo dnf install postgresql16-server
sudo postgresql-setup --initdb
sudo systemctl start postgresql
```

#### åˆ›å»ºæ•°æ®åº“

```bash
sudo -u postgres psql

CREATE USER rbac_admin WITH PASSWORD 'YourStrongPassword';
CREATE DATABASE rbac_admin OWNER rbac_admin;
GRANT ALL PRIVILEGES ON DATABASE rbac_admin TO rbac_admin;
\q
```

#### åˆå§‹åŒ–æ•°æ®

```bash
cd server-nestjs
pnpm prisma migrate deploy
pnpm prisma db seed
```

### 2. Redis å‡†å¤‡ï¼ˆç”Ÿäº§ç¯å¢ƒå»ºè®®å¯ç”¨ï¼‰

```bash
# Ubuntu/Debian
sudo apt install redis-server
sudo systemctl start redis

# éªŒè¯
redis-cli ping
```

### 3. åç«¯éƒ¨ç½²

```bash
cd server-nestjs

# å®‰è£…ä¾èµ–
pnpm install

# é…ç½®ç¯å¢ƒå˜é‡
cp .env.example .env
vim .env
```

å…³é”®é…ç½®ï¼š

```bash
NODE_ENV=production
PORT=3000

# æ•°æ®åº“ï¼ˆå¯†ç ä¸­çš„ç‰¹æ®Šå­—ç¬¦éœ€ URL ç¼–ç ï¼‰
DATABASE_URL="postgresql://rbac_admin:YourPassword@localhost:5432/rbac_admin"

# JWT å¯†é’¥ï¼ˆå¿…é¡»ä¿®æ”¹ï¼ï¼‰
JWT_SECRET=your-32-char-random-string

# Redis
REDIS_ENABLED=true
REDIS_URL=redis://127.0.0.1:6379

# CORS
CORS_ORIGINS=https://your-domain.com
```

```bash
# ç”Ÿæˆ Prisma Client
pnpm prisma generate

# æ„å»º
pnpm build

# å¯åŠ¨ï¼ˆæ¨èä½¿ç”¨ PM2ï¼‰
pm2 start dist/main.js --name rbac-server
```

### 4. å‰ç«¯éƒ¨ç½²

```bash
cd web

# å®‰è£…ä¾èµ–
pnpm install

# æ„å»º
pnpm build
```

å°† `dist` ç›®å½•éƒ¨ç½²åˆ° Web æœåŠ¡å™¨ã€‚

### 5. Nginx é…ç½®

```nginx
server {
    listen 80;
    server_name your-domain.com;
    
    # Gzip
    gzip on;
    gzip_types text/plain text/css application/javascript application/json;

    root /var/www/rbac-admin/dist;
    index index.html;

    # SPA è·¯ç”±
    location / {
        try_files $uri $uri/ /index.html;
    }

    # API ä»£ç†
    location /api/ {
        proxy_pass http://127.0.0.1:3000/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # é™æ€èµ„æºç¼“å­˜
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff2?)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}
```

---

## ç”Ÿäº§ç¯å¢ƒå®‰å…¨é…ç½®

### å®‰å…¨æ¸…å•

| é…ç½®é¡¹ | è¯´æ˜ |
|--------|------|
| `POSTGRES_PASSWORD` | ä½¿ç”¨å¼ºå¯†ç ï¼ˆ16+ å­—ç¬¦ï¼Œå«ç‰¹æ®Šå­—ç¬¦ï¼‰ |
| `JWT_SECRET` | è‡³å°‘ 32 ä½éšæœºå­—ç¬¦ä¸² |
| `CORS_ORIGINS` | é…ç½®å®é™…åŸŸåï¼Œä¸è¦ç”¨ `*` |
| `NODE_ENV` | è®¾ä¸º `production` |
| `ERROR_FULL` | è®¾ä¸º `false`ï¼Œéšè—è¯¦ç»†é”™è¯¯ |

### ç”Ÿæˆå®‰å…¨å¯†é’¥

```bash
# JWT å¯†é’¥
openssl rand -hex 32

# æˆ–ä½¿ç”¨ Node.js
node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
```

### HTTPS é…ç½®

```nginx
server {
    listen 443 ssl http2;
    server_name your-domain.com;

    ssl_certificate /etc/nginx/ssl/your-domain.crt;
    ssl_certificate_key /etc/nginx/ssl/your-domain.key;
    ssl_protocols TLSv1.2 TLSv1.3;

    # ... å…¶ä»–é…ç½®åŒä¸Š
}

server {
    listen 80;
    server_name your-domain.com;
    return 301 https://$server_name$request_uri;
}
```

### æ•°æ®å¤‡ä»½

```bash
# å¤‡ä»½
pg_dump -U rbac_admin rbac_admin > backup_$(date +%Y%m%d).sql

# æ¢å¤
psql -U rbac_admin rbac_admin < backup_20241210.sql
```

---

## å¸¸è§é—®é¢˜

### æ•°æ®åº“è¿æ¥å¤±è´¥

æ£€æŸ¥ `DATABASE_URL` æ ¼å¼ï¼Œå¯†ç ä¸­çš„ç‰¹æ®Šå­—ç¬¦éœ€ URL ç¼–ç ï¼š
- `@` â†’ `%40`
- `#` â†’ `%23`
- `:` â†’ `%3A`

### å‰ç«¯æ— æ³•è®¿é—® API

1. æ£€æŸ¥ `CORS_ORIGINS` é…ç½®
2. æ£€æŸ¥ Nginx ä»£ç†é…ç½®
3. ç¡®è®¤åç«¯æœåŠ¡æ­£å¸¸ï¼š`curl http://localhost:3000/health`

### Redis è¿æ¥å¤±è´¥

å¼€å‘ç¯å¢ƒå¯è®¾ç½® `REDIS_ENABLED=false` ä½¿ç”¨å†…å­˜æ¨¡å¼ã€‚

### PM2 å¸¸ç”¨å‘½ä»¤

```bash
pm2 start dist/main.js --name rbac-server  # å¯åŠ¨
pm2 restart rbac-server                     # é‡å¯
pm2 logs rbac-server                        # æŸ¥çœ‹æ—¥å¿—
pm2 monit                                   # ç›‘æ§
```

---

## ç›¸å…³æ–‡æ¡£

- [å®å¡” Docker éƒ¨ç½²æŒ‡å—](./å®å¡”Dockeréƒ¨ç½²æŒ‡å—.md) - å®å¡”é¢æ¿ + Docker éƒ¨ç½²
- [Zeabur éƒ¨ç½²æŒ‡å—](../zeabur-deploy.md) - Zeabur äº‘å¹³å°éƒ¨ç½²

---

**æœ€åæ›´æ–°**: 2025-12-26

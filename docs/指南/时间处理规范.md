# 时间处理规范

## 一、概述

本项目采用 **UTC 时间存储 + 前端本地化显示** 的方案，确保全球用户看到正确的本地时间。

## 二、时间流转过程

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│   前端      │     │   后端      │     │   数据库    │     │   前端      │
│  new Date() │ ──▶ │  接收 ISO   │ ──▶ │  存储 UTC   │ ──▶ │  显示本地   │
│  (本地时间) │     │  字符串     │     │  时间戳     │     │  时间       │
└─────────────┘     └─────────────┘     └─────────────┘     └─────────────┘
```

### 示例

用户在北京时间 `2026-01-04 21:40:30` 操作上链：

| 阶段 | 时间值 | 说明 |
|------|--------|------|
| 后端 `new Date()` | `2026-01-04T13:40:30.770Z` | JavaScript 自动转为 UTC |
| 数据库存储 | `2026-01-04 13:40:30.77` | PostgreSQL 存储 UTC |
| API 返回 | `"2026-01-04T13:40:30.770Z"` | ISO 8601 格式，带 `Z` 后缀 |
| 前端显示 | `2026/1/4 21:40:30` | 浏览器自动转为本地时区 |

## 三、后端规范

### 3.1 Prisma Schema

使用 `DateTime` 类型，Prisma 会自动处理时区转换：

```prisma
model UserSeal {
  chainTime  DateTime?  @map("chain_time")
  createTime DateTime   @default(now()) @map("create_time")
  updateTime DateTime   @updatedAt @map("update_time")
}
```

### 3.2 创建时间

```typescript
// ✅ 正确：使用 new Date()，自动为 UTC
await prisma.userSeal.update({
  data: {
    chainTime: new Date(),
  },
});

// ❌ 错误：手动构造本地时间字符串
await prisma.userSeal.update({
  data: {
    chainTime: '2026-01-04 21:40:30', // 会被当作 UTC 存储，导致时间错误
  },
});
```

### 3.3 API 响应

Prisma 返回的 `Date` 对象会被 NestJS 自动序列化为 ISO 8601 字符串：

```json
{
  "chainTime": "2026-01-04T13:40:30.770Z",
  "createTime": "2026-01-04T05:38:41.135Z"
}
```

## 四、前端规范

### 4.1 原生 JavaScript

```javascript
const utcTime = "2026-01-04T13:40:30.770Z";

// 自动转换为本地时区
new Date(utcTime).toLocaleString();
// 输出: "2026/1/4 21:40:30" (北京时间)

new Date(utcTime).toLocaleString('zh-CN', {
  year: 'numeric',
  month: '2-digit',
  day: '2-digit',
  hour: '2-digit',
  minute: '2-digit',
  second: '2-digit',
});
// 输出: "2026/01/04 21:40:30"
```

### 4.2 使用 dayjs

```javascript
import dayjs from 'dayjs';

const utcTime = "2026-01-04T13:40:30.770Z";

// 自动识别 UTC 并转换为本地时区
dayjs(utcTime).format('YYYY-MM-DD HH:mm:ss');
// 输出: "2026-01-04 21:40:30" (北京时间)
```

### 4.3 使用 date-fns

```javascript
import { format, parseISO } from 'date-fns';

const utcTime = "2026-01-04T13:40:30.770Z";

format(parseISO(utcTime), 'yyyy-MM-dd HH:mm:ss');
// 输出: "2026-01-04 21:40:30" (北京时间)
```

### 4.4 Vue 项目中的全局过滤器

```typescript
// utils/date.ts
import dayjs from 'dayjs';

export function formatDateTime(value: string | Date | null | undefined): string {
  if (!value) return '-';
  return dayjs(value).format('YYYY-MM-DD HH:mm:ss');
}

export function formatDate(value: string | Date | null | undefined): string {
  if (!value) return '-';
  return dayjs(value).format('YYYY-MM-DD');
}
```

```vue
<template>
  <span>{{ formatDateTime(row.chainTime) }}</span>
</template>

<script setup>
import { formatDateTime } from '@/utils/date';
</script>
```

## 五、常见问题

### Q1: 数据库查询的时间和本地时间差 8 小时？

这是正常的。数据库存储的是 UTC 时间，北京时间是 UTC+8。

```sql
-- 数据库显示 UTC 时间
SELECT chain_time FROM user_seal;
-- 结果: 2026-01-04 13:40:30

-- 实际对应北京时间: 2026-01-04 21:40:30
```

### Q2: 前端显示的时间不对？

检查是否正确解析了 ISO 字符串：

```javascript
// ❌ 错误：直接截取字符串，丢失时区信息
const time = "2026-01-04T13:40:30.770Z".slice(0, 19);
// 结果: "2026-01-04T13:40:30" (被当作本地时间)

// ✅ 正确：使用 Date 或 dayjs 解析
const time = dayjs("2026-01-04T13:40:30.770Z").format('YYYY-MM-DD HH:mm:ss');
// 结果: "2026-01-04 21:40:30" (正确的本地时间)
```

### Q3: 如何按日期筛选数据？

后端接收本地日期，转换为 UTC 范围查询：

```typescript
// 前端传入: startDate=2026-01-04, endDate=2026-01-04
// 表示查询北京时间 2026-01-04 00:00:00 ~ 2026-01-04 23:59:59

// 后端转换为 UTC 范围
const startUtc = new Date('2026-01-04T00:00:00+08:00'); // 2026-01-03T16:00:00Z
const endUtc = new Date('2026-01-04T23:59:59+08:00');   // 2026-01-04T15:59:59Z

await prisma.userSeal.findMany({
  where: {
    chainTime: {
      gte: startUtc,
      lte: endUtc,
    },
  },
});
```

### Q4: 种子数据的时间如何设置？

使用 ISO 字符串明确指定时区：

```typescript
// seed.ts
await prisma.userSeal.create({
  data: {
    // 指定北京时间
    chainTime: new Date('2025-01-10T16:00:00+08:00'),
    // 或使用 UTC
    chainTime: new Date('2025-01-10T08:00:00Z'),
  },
});
```

## 六、PostgreSQL 时间类型说明

| 类型 | Prisma 类型 | 说明 |
|------|-------------|------|
| `TIMESTAMP` | `DateTime` | 不带时区，存储 UTC |
| `TIMESTAMPTZ` | `DateTime` | 带时区，自动转换 |

本项目使用 `TIMESTAMP`（Prisma 默认），由应用层统一处理时区。

## 七、总结

| 层级 | 时间格式 | 时区 |
|------|----------|------|
| 数据库 | `TIMESTAMP` | UTC |
| API 传输 | ISO 8601 (`Z` 后缀) | UTC |
| 前端显示 | 本地格式化 | 用户本地时区 |

遵循此规范，可确保：
- 全球用户看到正确的本地时间
- 数据库时间一致，便于排序和比较
- 避免夏令时等时区问题

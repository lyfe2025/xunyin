# 文件存储配置指南

本指南介绍如何在 RBAC Admin 系统中配置文件存储服务，支持本地存储和云存储（阿里云 OSS、腾讯云 COS、Cloudflare R2）。

## 配置入口

系统设置 → 存储设置

## 存储类型

| 类型 | 说明 | 适用场景 |
|------|------|----------|
| 本地存储 | 文件存储在服务器本地 | 开发测试、小型项目 |
| AWS S3 | 亚马逊云对象存储 | 海外生产环境 |
| Google Cloud Storage | 谷歌云对象存储 | 海外生产环境 |
| 阿里云 OSS | 阿里云对象存储 | 国内生产环境 |
| 腾讯云 COS | 腾讯云对象存储 | 国内生产环境 |
| Cloudflare R2 | Cloudflare 对象存储 | 海外/全球加速 |

## 本地存储配置

最简单的配置方式，文件存储在服务器本地磁盘。

| 配置项 | 说明 | 默认值 |
|--------|------|--------|
| 存储路径 | 文件存储目录 | ./uploads |

**注意事项**：
- 确保目录有写入权限
- 生产环境建议配置 Nginx 静态文件服务
- 不适合分布式部署

## AWS S3 配置

### 1. 创建 S3 存储桶

1. 登录 [AWS S3 控制台](https://s3.console.aws.amazon.com/)
2. 创建存储桶，选择合适的区域
3. 配置公开访问设置（根据需求）

### 2. 获取访问密钥

1. 进入 [IAM 控制台](https://console.aws.amazon.com/iam/)
2. 创建用户或使用现有用户
3. 附加 `AmazonS3FullAccess` 策略（或自定义策略）
4. 创建访问密钥，保存 Access Key ID 和 Secret Access Key

### 3. 填写配置

```
存储类型: AWS S3
服务端点: s3.us-east-1.amazonaws.com
存储桶: your-bucket-name
Access Key ID: AKIAxxxxxxxx
Secret Access Key: xxxxxxxx
```

**Endpoint 格式**：`s3.{region}.amazonaws.com`

常用区域：
- 美东: `s3.us-east-1.amazonaws.com`
- 美西: `s3.us-west-2.amazonaws.com`
- 欧洲: `s3.eu-west-1.amazonaws.com`
- 亚太: `s3.ap-northeast-1.amazonaws.com`

## Google Cloud Storage 配置

### 1. 创建存储桶

1. 登录 [Google Cloud Console](https://console.cloud.google.com/storage)
2. 创建存储桶，选择位置和存储类别
3. 配置访问权限

### 2. 创建服务账号密钥

1. 进入 [IAM 和管理](https://console.cloud.google.com/iam-admin/serviceaccounts)
2. 创建服务账号
3. 授予 `Storage Object Admin` 角色
4. 创建密钥（JSON 格式）
5. 从 JSON 中提取 `client_email` 和 `private_key`

### 3. 启用互操作性 API

GCS 支持 S3 兼容 API，需要启用：
1. 进入 Cloud Storage → 设置 → 互操作性
2. 创建 HMAC 密钥
3. 保存 Access Key 和 Secret

### 4. 填写配置

```
存储类型: Google Cloud Storage
服务端点: storage.googleapis.com
存储桶: your-bucket-name
Access Key ID: GOOGxxxxxxxx
Secret Access Key: xxxxxxxx
```

**注意**：GCS 使用 HMAC 密钥进行 S3 兼容访问

## 阿里云 OSS 配置

### 1. 创建 Bucket

1. 登录 [阿里云 OSS 控制台](https://oss.console.aliyun.com/)
2. 创建 Bucket，选择合适的地域
3. 权限设置为「私有」或「公共读」

### 2. 获取 AccessKey

1. 进入 [RAM 访问控制](https://ram.console.aliyun.com/)
2. 创建用户，勾选「编程访问」
3. 为用户授权 `AliyunOSSFullAccess` 权限
4. 保存 AccessKey ID 和 AccessKey Secret

### 3. 填写配置

```
存储类型: 阿里云 OSS
服务端点: oss-cn-hangzhou.aliyuncs.com
存储桶: your-bucket-name
AccessKey ID: LTAI5t...
AccessKey Secret: xxxxxxxx
```

**Endpoint 格式**：`oss-{region}.aliyuncs.com`

常用地域：
- 杭州: `oss-cn-hangzhou.aliyuncs.com`
- 上海: `oss-cn-shanghai.aliyuncs.com`
- 北京: `oss-cn-beijing.aliyuncs.com`
- 深圳: `oss-cn-shenzhen.aliyuncs.com`

## 腾讯云 COS 配置

### 1. 创建存储桶

1. 登录 [腾讯云 COS 控制台](https://console.cloud.tencent.com/cos)
2. 创建存储桶，选择地域
3. 设置访问权限

### 2. 获取密钥

1. 进入 [API 密钥管理](https://console.cloud.tencent.com/cam/capi)
2. 创建密钥或使用已有密钥
3. 保存 SecretId 和 SecretKey

### 3. 填写配置

```
存储类型: 腾讯云 COS
服务端点: cos.ap-guangzhou.myqcloud.com
存储桶: your-bucket-1250000000
AccessKey ID: AKIDxxxxxxxx
AccessKey Secret: xxxxxxxx
```

**Endpoint 格式**：`cos.{region}.myqcloud.com`

常用地域：
- 广州: `cos.ap-guangzhou.myqcloud.com`
- 上海: `cos.ap-shanghai.myqcloud.com`
- 北京: `cos.ap-beijing.myqcloud.com`
- 成都: `cos.ap-chengdu.myqcloud.com`

**注意**：存储桶名称格式为 `{bucket}-{appid}`

## Cloudflare R2 配置

### 1. 创建 R2 存储桶

1. 登录 [Cloudflare Dashboard](https://dash.cloudflare.com/)
2. 进入 R2 → 创建存储桶
3. 记录存储桶名称

### 2. 获取 API 令牌

1. R2 → 管理 R2 API 令牌
2. 创建 API 令牌，权限选择「对象读写」
3. 保存 Access Key ID 和 Secret Access Key
4. 记录账户 ID（在 URL 中可见）

### 3. 填写配置

```
存储类型: Cloudflare R2
服务端点: {account_id}.r2.cloudflarestorage.com
存储桶: your-bucket-name
Access Key ID: xxxxxxxx
Secret Access Key: xxxxxxxx
```

**Endpoint 格式**：`{account_id}.r2.cloudflarestorage.com`

### 4. 配置公开访问（可选）

R2 默认不提供公开访问 URL，需要配置：
- 方式一：绑定自定义域名
- 方式二：使用 Cloudflare Workers

## 常见问题

### 1. 上传失败：Access Denied

- 检查 AccessKey 是否正确
- 检查用户是否有存储桶的写入权限
- 检查存储桶策略是否允许上传

### 2. 上传成功但无法访问

- 检查存储桶是否设置为公共读
- 检查是否配置了正确的访问域名
- R2 需要额外配置公开访问

### 3. 跨域问题 (CORS)

需要在云存储控制台配置 CORS 规则：

```json
[
  {
    "AllowedOrigins": ["*"],
    "AllowedMethods": ["GET", "PUT", "POST", "DELETE"],
    "AllowedHeaders": ["*"],
    "MaxAgeSeconds": 3000
  }
]
```

### 4. 切换存储类型后旧文件无法访问

切换存储类型不会迁移已有文件，需要：
1. 手动迁移文件到新存储
2. 或保留旧存储的访问配置

## 安全建议

1. **最小权限原则**：只授予必要的存储桶权限
2. **使用子账号**：不要使用主账号的 AccessKey
3. **定期轮换密钥**：定期更换 AccessKey
4. **私有存储桶**：敏感文件使用私有存储桶 + 签名 URL
5. **开启日志**：开启存储桶访问日志便于审计

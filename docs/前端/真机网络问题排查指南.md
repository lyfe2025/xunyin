# Flutter 真机网络问题排查指南

## 问题现象

在 iOS 真机上运行 Flutter App 时，出现网络请求失败，错误信息如下：

```
[ERROR] DioException Type: DioExceptionType.connectionError
[ERROR] Message: The connection errored: Connection reset by peer
[ERROR] Error: SocketException: Connection reset by peer (OS Error: Connection reset by peer, errno = 54)
```

**关键特征**：
- ✅ 模拟器上网络请求正常
- ❌ 真机使用 WiFi 时请求失败
- ✅ 真机使用 4G/5G 时请求正常
- 每次请求使用不同的随机端口（如 62105, 62108, 62114...）

## 根本原因

**真机的 WiFi 配置了 HTTP 代理，但代理服务器不可用。**

### 网络请求流程对比

#### 真机 WiFi（有问题）
```
App → WiFi（配置了代理）→ 代理服务器（不可用）→ ❌ Connection reset
```

#### 模拟器 WiFi（正常）
```
App → WiFi（无代理）→ 直接访问服务器 → ✅ 成功
```

#### 真机 4G/5G（正常）
```
App → 蜂窝网络（无代理）→ 直接访问服务器 → ✅ 成功
```

## 如何检查 WiFi 是否配置了代理

### iPhone/iPad 检查步骤

#### 方法 1：通过设置 App 查看（推荐）

1. **打开设置 App**
   - 点击主屏幕的「设置」图标

2. **进入 Wi-Fi 设置**
   - 点击「Wi-Fi」选项

3. **查看当前连接的 WiFi**
   - 找到已连接的 WiFi（旁边有 ✓ 标记）
   - 点击 WiFi 名称右侧的 **(i)** 信息图标

4. **向下滚动到「HTTP 代理」部分**
   - 在 WiFi 详情页面向下滚动
   - 找到「HTTP 代理」或「配置代理」部分

5. **查看代理状态**

   **✅ 正常情况（无代理）：**
   ```
   HTTP 代理
   ○ 关闭          ← 选中这个
   ○ 手动
   ○ 自动
   ```

   **⚠️ 配置了手动代理：**
   ```
   HTTP 代理
   ○ 关闭
   ● 手动          ← 选中这个
   ○ 自动
   
   服务器: 192.168.1.100
   端口: 8888
   ```

   **⚠️ 配置了自动代理：**
   ```
   HTTP 代理
   ○ 关闭
   ○ 手动
   ● 自动          ← 选中这个
   
   URL: http://proxy.company.com/proxy.pac
   ```

#### 方法 2：通过网络请求判断

如果你不确定代理是否可用，可以通过 App 的网络请求日志判断：

**有代理问题的日志特征：**
```
[ERROR] DioException Type: DioExceptionType.connectionError
[ERROR] Message: Connection reset by peer
[ERROR] Error: SocketException: Connection reset by peer (errno = 54)
[ERROR] port = 62105  ← 随机端口号
```

**正常的日志：**
```
[DIO] *** Response ***
[DIO] statusCode: 200
[DIO] data: {...}
```

### Android 检查步骤

1. **打开设置**
   - 点击「设置」图标

2. **进入 Wi-Fi 设置**
   - 点击「网络和互联网」或「连接」
   - 点击「Wi-Fi」

3. **查看当前 WiFi**
   - 长按已连接的 WiFi 名称
   - 选择「修改网络」或「网络详情」

4. **查看代理设置**
   - 点击「高级选项」
   - 找到「代理」设置
   - 查看是否为「无」

### Mac 检查步骤（模拟器使用的网络）

1. **打开系统设置**
   - 点击左上角  → 系统设置

2. **进入网络设置**
   - 点击「网络」

3. **选择当前网络**
   - 点击已连接的 WiFi 或以太网

4. **查看代理设置**
   - 点击「详细信息」
   - 点击「代理」标签
   - 查看是否勾选了任何代理协议

## 常见代理配置识别

### 代理地址特征

| 代理类型 | 地址示例 | 说明 |
|---------|---------|------|
| **本地抓包工具** | `127.0.0.1:8888`<br>`localhost:9090` | Charles、Proxyman 等 |
| **局域网代理** | `192.168.x.x:xxxx`<br>`10.0.x.x:xxxx` | 同一网络内的代理服务器 |
| **企业代理** | `proxy.company.com:8080`<br>`proxy.example.com:3128` | 公司内部代理服务器 |
| **PAC 自动配置** | `http://wpad.company.com/proxy.pac`<br>`http://proxy.example.com/wpad.dat` | 自动代理配置文件 |

### 常见端口号

| 端口 | 用途 |
|------|------|
| `8888` | Charles 默认端口 |
| `9090` | Proxyman 默认端口 |
| `8080` | 常见的 HTTP 代理端口 |
| `3128` | Squid 代理默认端口 |
| `1080` | SOCKS 代理常用端口 |

## 快速检查清单

在遇到网络问题时，按以下顺序检查：

- [ ] **步骤 1**：打开设置 → Wi-Fi → 点击 (i)
- [ ] **步骤 2**：滚动到「HTTP 代理」部分
- [ ] **步骤 3**：检查是否选中「关闭」
- [ ] **步骤 4**：如果不是「关闭」，记录代理地址
- [ ] **步骤 5**：判断代理是否可用（是否在运行）
- [ ] **步骤 6**：选择解决方案：
  - 关闭代理（如果可以修改）
  - 切换到其他 WiFi
  - 使用 4G/5G

## 解决方案

### 方案 1：关闭当前 WiFi 的代理（推荐）

在 iPhone 上操作：

1. 打开「设置」App
2. 点击「Wi-Fi」
3. 点击已连接的 WiFi 右侧的 **(i)** 图标
4. 向下滚动到「HTTP 代理」部分
5. 选择「关闭」

![WiFi 代理设置](https://docs-assets.developer.apple.com/published/example.png)

### 方案 2：切换到其他 WiFi 网络

如果当前 WiFi 的代理设置无法修改（如公司网络），可以：

1. 打开「设置」→「Wi-Fi」
2. 连接到其他 WiFi 网络（如：
   - 家里的 WiFi
   - 手机热点
   - 咖啡厅的公共 WiFi
   - 其他没有配置代理的网络）

**优点**：
- 无需修改原 WiFi 配置
- 适合公司网络强制代理的场景
- 可以保留原网络配置用于其他用途

**注意**：
- 新 WiFi 也可能配置了代理，需要检查
- 每个 WiFi 的代理配置是独立的

### 方案 3：使用 4G/5G 网络

临时解决方案：关闭 WiFi，使用蜂窝数据网络。

**适用场景**：
- 快速测试
- 没有其他可用 WiFi
- 流量充足的情况

### 方案 4：配置正确的代理

如果需要使用代理（如公司网络要求），确保：
- 代理服务器地址正确
- 代理服务器正在运行
- 代理服务器允许访问目标域名

## 常见代理配置场景

| 场景 | 代理地址示例 | 说明 |
|------|-------------|------|
| **Charles 抓包** | `127.0.0.1:8888` | 本地抓包工具，需要 Charles 运行中 |
| **Proxyman** | `127.0.0.1:9090` | 本地抓包工具，需要 Proxyman 运行中 |
| **公司网络** | `proxy.company.com:8080` | 企业代理服务器 |
| **VPN 应用** | 自动配置 | 某些 VPN 会自动设置代理 |
| **调试工具** | `192.168.x.x:xxxx` | 局域网内的调试代理 |

## 为什么模拟器正常

iOS 模拟器和真机的网络配置是**独立**的：

- **真机**：使用设备自己的网络设置（WiFi/蜂窝网络）
- **模拟器**：使用 Mac 的网络设置，默认不继承真机的代理配置

所以即使真机配置了代理，模拟器也不受影响。

## 技术细节

### 错误码 errno = 54

`errno = 54` 对应 `ECONNRESET`，表示连接被对方重置。常见原因：
- 代理服务器拒绝连接
- 代理服务器未运行
- 防火墙阻止连接
- 网络配置错误

### 随机端口说明

错误日志中的端口号（62105, 62108...）是**客户端临时端口**（ephemeral port）：
- 操作系统为每个新的 TCP 连接分配
- 范围通常是 49152-65535
- 用于与代理服务器建立连接
- 每次请求都会使用新的端口

这**不是**服务器端口（服务器端口是 443 for HTTPS）。

## 排查步骤

### 第 1 步：检查代理配置

**iPhone 操作：**
```
设置 → Wi-Fi → 点击已连接 WiFi 的 (i) → 查看「HTTP 代理」
```

**判断标准：**
- ✅ 显示「关闭」→ 无代理，正常
- ⚠️ 显示「手动」→ 配置了代理，需要检查
- ⚠️ 显示「自动」→ 配置了 PAC 代理，需要检查

### 第 2 步：确认问题

如果配置了代理，运行 App 并查看日志：

```bash
# 在真机上查看网络请求日志
cd app_flutter
flutter run --verbose
```

**查找关键信息：**
- ❌ `Connection reset by peer` → 代理不可用
- ❌ `errno = 54` → 连接被重置
- ❌ 随机端口号（62105, 62108...）→ 代理连接失败
- ✅ `statusCode: 200` → 网络正常

### 第 3 步：判断代理是否可用

如果配置了代理，检查：

**本地代理（127.0.0.1 或 localhost）：**
- [ ] Charles/Proxyman 是否正在运行？
- [ ] 代理端口是否正确？
- [ ] SSL 证书是否已信任？

**企业代理（公司域名）：**
- [ ] 是否在公司网络内？
- [ ] 代理服务器是否正常运行？
- [ ] 目标域名是否在白名单中？

**局域网代理（192.168.x.x）：**
- [ ] 代理服务器是否在线？
- [ ] 是否在同一局域网？
- [ ] 防火墙是否允许连接？

### 第 4 步：选择解决方案

根据检查结果选择：

| 情况 | 推荐方案 |
|------|---------|
| 自己配置的代理（抓包工具） | 关闭代理或启动抓包工具 |
| 公司网络强制代理 | 切换到其他 WiFi 或使用手机热点 |
| 不知道为什么有代理 | 直接关闭代理 |
| 无法修改代理设置 | 切换到其他 WiFi 或使用 4G/5G |

### 第 5 步：验证修复

修改后重新运行 App：

```bash
cd app_flutter
flutter run
```

**应该看到：**
```
[DIO] *** Request ***
[DIO] uri: https://xunyin.pynb.org/api/app/config/splash/current
[DIO] method: GET
[DIO] *** Response ***
[DIO] statusCode: 200
[DIO] data: {...}
```

**如果还是失败：**
1. 确认代理确实已关闭（重新检查设置）
2. 尝试切换到其他 WiFi
3. 尝试使用 4G/5G
4. 重启手机（刷新网络配置）

## 预防措施

### 开发环境配置建议

1. **调试完成后关闭代理**
   - 使用 Charles/Proxyman 抓包后，记得关闭代理
   - 或者退出抓包工具（会自动关闭代理）

2. **使用独立的测试 WiFi**
   - 为开发测试创建独立的 WiFi 网络
   - 不配置代理，避免干扰

3. **文档化代理配置**
   - 记录哪些网络需要代理
   - 记录代理服务器地址和端口

### 代码层面优化

项目已实现的优化：

1. **详细的网络日志**（`api_client.dart`）
   ```dart
   interceptors.add(LogInterceptor(
     requestHeader: true,
     responseHeader: true,
     error: true,
   ));
   ```

2. **超时配置**
   ```dart
   connectTimeout: const Duration(seconds: 30),
   receiveTimeout: const Duration(seconds: 30),
   ```

3. **错误处理**
   ```dart
   try {
     final response = await api.get('/endpoint');
   } on DioException catch (e) {
     if (e.type == DioExceptionType.connectionError) {
       // 连接错误处理
     }
   }
   ```

## 相关文档

- [iOS 网络配置文档](https://developer.apple.com/documentation/foundation/url_loading_system)
- [Dio 错误处理](https://pub.dev/packages/dio#error-handling)
- [Charles 代理配置](https://www.charlesproxy.com/documentation/proxying/)

## 常见问题

### Q: 为什么关闭 WiFi 就可以了？

A: 因为蜂窝网络（4G/5G）通常不会配置代理，可以直接访问服务器。

### Q: 换个 WiFi 能解决吗？

A: 可以！每个 WiFi 的代理配置是独立的。如果当前 WiFi 配置了不可用的代理，切换到其他 WiFi（如家里的网络、手机热点）就能解决。这是最简单的方法，特别适合公司网络强制代理的场景。

### Q: 为什么有些 WiFi 有问题，有些没问题？

A: 因为每个 WiFi 网络的代理配置是独立保存的：
- **公司 WiFi**：可能配置了企业代理
- **家里 WiFi**：通常没有代理
- **咖啡厅 WiFi**：通常没有代理
- **手机热点**：不会有代理

所以同一部手机连接不同 WiFi 时，网络行为可能完全不同。

### Q: 我需要使用代理抓包怎么办？

A: 确保抓包工具（Charles/Proxyman）正在运行，并且配置了 SSL 证书信任。抓包完成后记得关闭代理或退出工具。

### Q: 公司网络必须使用代理怎么办？

A: 有几个选择：
1. **切换网络**：使用手机热点或其他 WiFi 进行开发测试
2. **配置白名单**：联系 IT 部门将 API 域名加入代理白名单
3. **使用 VPN**：通过 VPN 绕过公司代理（需符合公司政策）

### Q: 如何在代码中检测代理问题？

A: 可以通过捕获 `DioExceptionType.connectionError` 并检查错误信息是否包含 "Connection reset" 来判断。

### Q: 如何查看当前 WiFi 是否配置了代理？

A: 在 iPhone 上：设置 → Wi-Fi → 点击已连接 WiFi 的 (i) → 查看「HTTP 代理」部分。如果显示「关闭」就是正常的。

## 总结

| 环境 | 网络类型 | 代理状态 | 结果 | 原因 |
|------|---------|---------|------|------|
| 真机 | WiFi A | ✅ 已配置（不可用） | ❌ 失败 | 代理服务器不可用 |
| 真机 | WiFi A | ❌ 关闭代理 | ✅ 成功 | 直接访问服务器 |
| 真机 | WiFi B | ❌ 未配置 | ✅ 成功 | 直接访问服务器 |
| 真机 | 4G/5G | - | ✅ 成功 | 蜂窝网络无代理 |
| 真机 | 手机热点 | - | ✅ 成功 | 热点无代理 |
| 模拟器 | - | - | ✅ 成功 | 使用 Mac 网络设置 |

## 快速解决方案对比

| 方案 | 操作难度 | 适用场景 | 推荐度 |
|------|---------|---------|--------|
| 关闭当前 WiFi 代理 | ⭐ 简单 | 自己的 WiFi，有修改权限 | ⭐⭐⭐⭐⭐ |
| 切换到其他 WiFi | ⭐ 简单 | 公司网络无法修改，有其他 WiFi 可用 | ⭐⭐⭐⭐⭐ |
| 使用手机热点 | ⭐ 简单 | 没有其他 WiFi，流量充足 | ⭐⭐⭐⭐ |
| 使用 4G/5G | ⭐ 最简单 | 临时测试，流量充足 | ⭐⭐⭐⭐ |
| 配置正确的代理 | ⭐⭐⭐ 复杂 | 必须使用代理的场景 | ⭐⭐ |

**最佳实践**：
- 日常开发：使用没有代理的 WiFi 或关闭代理
- 需要抓包：临时开启代理，完成后立即关闭
- 公司网络：使用手机热点或其他 WiFi 进行开发测试
- 记住：**每个 WiFi 的代理配置是独立的**，切换网络是最简单的解决方案

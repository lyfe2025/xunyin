# é”™è¯¯å¤„ç†è§„èŒƒ

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£å®šä¹‰äº†å‰åç«¯ç»Ÿä¸€çš„é”™è¯¯å¤„ç†è§„èŒƒ,ç¡®ä¿é”™è¯¯ä¿¡æ¯çš„ä¸€è‡´æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚

## åç«¯é”™è¯¯å¤„ç†

### 1. é”™è¯¯ç å®šä¹‰

æ‰€æœ‰ä¸šåŠ¡é”™è¯¯å¿…é¡»ä½¿ç”¨ç»Ÿä¸€çš„é”™è¯¯ç ,å®šä¹‰åœ¨ `src/common/enums/error-code.enum.ts`:

\`\`\`typescript
export enum ErrorCode {
  // é€šç”¨é”™è¯¯ç  (10xxx)
  SUCCESS = 10000,
  INTERNAL_ERROR = 10001,
  INVALID_PARAMS = 10002,
  
  // è®¤è¯é”™è¯¯ç  (20xxx)
  UNAUTHORIZED = 20001,
  TOKEN_EXPIRED = 20002,
  FORBIDDEN = 20003,
  
  // ç”¨æˆ·é”™è¯¯ç  (30xxx)
  USER_NOT_FOUND = 30001,
  USER_ALREADY_EXISTS = 30002,
  CANNOT_DELETE_SELF = 30003,
  
  // è§’è‰²é”™è¯¯ç  (40xxx)
  ROLE_NOT_FOUND = 40001,
  ROLE_ALREADY_EXISTS = 40002,
  
  // éƒ¨é—¨é”™è¯¯ç  (50xxx)
  DEPT_NOT_FOUND = 50001,
  DEPT_HAS_CHILDREN = 50002,
  
  // èœå•é”™è¯¯ç  (60xxx)
  MENU_NOT_FOUND = 60001,
}
\`\`\`

### 2. æŠ›å‡ºä¸šåŠ¡å¼‚å¸¸

**å¯¼å…¥:**
\`\`\`typescript
import { BusinessException } from '@/common/exceptions';
import { ErrorCode } from '@/common/enums';
\`\`\`

**ä½¿ç”¨:**
\`\`\`typescript
// âœ… æ­£ç¡®
throw new BusinessException(ErrorCode.USER_NOT_FOUND);

// âŒ é”™è¯¯
throw new Error('ç”¨æˆ·ä¸å­˜åœ¨');
throw new HttpException('ç”¨æˆ·ä¸å­˜åœ¨', HttpStatus.NOT_FOUND);
\`\`\`

### 3. HTTP çŠ¶æ€ç æ˜ å°„

| é”™è¯¯ç  | HTTP çŠ¶æ€ç  | è¯´æ˜ |
|--------|------------|------|
| `ErrorCode.SUCCESS` | 200 | æˆåŠŸ |
| `ErrorCode.UNAUTHORIZED` | 401 | æœªç™»å½• |
| `ErrorCode.FORBIDDEN` | 403 | æ— æƒé™ |
| `ErrorCode.INTERNAL_ERROR` | 500 | æœåŠ¡å™¨é”™è¯¯ |
| å…¶ä»–ä¸šåŠ¡é”™è¯¯ | 200 | ä¸šåŠ¡é”™è¯¯è¿”å› 200 |

### 4. å“åº”æ ¼å¼

**æˆåŠŸå“åº”:**
\`\`\`json
{
  "code": 10000,
  "msg": "æ“ä½œæˆåŠŸ",
  "data": { ... }
}
\`\`\`

**é”™è¯¯å“åº”:**
\`\`\`json
{
  "code": 30001,
  "msg": "ç”¨æˆ·ä¸å­˜åœ¨",
  "data": null
}
\`\`\`

## å‰ç«¯é”™è¯¯å¤„ç†

### 1. é”™è¯¯ç å®šä¹‰

å‰ç«¯é”™è¯¯ç å®šä¹‰åœ¨ `src/types/error-code.ts`,ä¸åç«¯ä¿æŒä¸€è‡´:

\`\`\`typescript
export enum ErrorCode {
  SUCCESS = 10000,
  UNAUTHORIZED = 20001,
  USER_NOT_FOUND = 30001,
  // ...
}
\`\`\`

### 2. é”™è¯¯æ¶ˆæ¯æ˜ å°„

å®šä¹‰åœ¨ `src/utils/error-message.ts`:

\`\`\`typescript
export function getErrorMessage(code: number): string {
  const messages: Record<number, string> = {
    [ErrorCode.SUCCESS]: 'æ“ä½œæˆåŠŸ',
    [ErrorCode.UNAUTHORIZED]: 'è¯·å…ˆç™»å½•',
    [ErrorCode.USER_NOT_FOUND]: 'ç”¨æˆ·ä¸å­˜åœ¨',
    // ...
  };
  return messages[code] || 'æ“ä½œå¤±è´¥';
}
\`\`\`

### 3. Axios æ‹¦æˆªå™¨

**å“åº”æˆåŠŸæ‹¦æˆªå™¨ (HTTP 200):**
\`\`\`typescript
response => {
  const { code, msg, data } = response.data;
  
  // æ£€æŸ¥æ˜¯å¦éœ€è¦è·³è½¬ç™»å½•
  if (shouldRedirectToLogin(code)) {
    router.push('/login');
    return Promise.reject(new Error(msg || 'è¯·å…ˆç™»å½•'));
  }
  
  // ä¸šåŠ¡æˆåŠŸ
  if (code === ErrorCode.SUCCESS) {
    return data;
  }
  
  // ä¸šåŠ¡é”™è¯¯
  const errorMsg = msg || getErrorMessage(code);
  message.error(errorMsg);
  return Promise.reject(new Error(errorMsg));
}
\`\`\`

**å“åº”é”™è¯¯æ‹¦æˆªå™¨ (HTTP é 200):**
\`\`\`typescript
error => {
  const { response } = error;
  
  if (response) {
    const errorMsg = response.data?.msg || getHttpErrorMessage(response.status);
    message.error(errorMsg);
  } else {
    message.error('ç½‘ç»œé”™è¯¯,è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
  }
  
  return Promise.reject(error);
}
\`\`\`

### 4. ç»„ä»¶ä¸­å¤„ç†ç‰¹æ®Šé”™è¯¯

\`\`\`typescript
import { ErrorCode } from '@/types/error-code';

try {
  await deleteUser(userId);
  message.success('åˆ é™¤æˆåŠŸ');
} catch (error: any) {
  // ç‰¹æ®Šé”™è¯¯å¤„ç†
  if (error.code === ErrorCode.CANNOT_DELETE_SELF) {
    message.warning('ä¸èƒ½åˆ é™¤è‡ªå·±');
  }
  // å…¶ä»–é”™è¯¯å·²åœ¨æ‹¦æˆªå™¨ä¸­å¤„ç†
}
\`\`\`

## æœ€ä½³å®è·µ

### âœ… æ¨èåšæ³•

1. **ä½¿ç”¨é”™è¯¯ç ,ä¸ç”¨å­—ç¬¦ä¸²**
   \`\`\`typescript
   // âœ… æ­£ç¡®
   throw new BusinessException(ErrorCode.USER_NOT_FOUND);
   
   // âŒ é”™è¯¯
   throw new Error('ç”¨æˆ·ä¸å­˜åœ¨');
   \`\`\`

2. **å‰åç«¯é”™è¯¯ç ä¿æŒä¸€è‡´**
   - åç«¯: `src/common/enums/error-code.enum.ts`
   - å‰ç«¯: `src/types/error-code.ts`

3. **ä¼˜å…ˆä½¿ç”¨åç«¯è¿”å›çš„é”™è¯¯æ¶ˆæ¯**
   \`\`\`typescript
   const errorMsg = msg || getErrorMessage(code);
   \`\`\`

4. **ç‰¹æ®Šé”™è¯¯åœ¨ç»„ä»¶ä¸­å¤„ç†**
   - é€šç”¨é”™è¯¯: æ‹¦æˆªå™¨ç»Ÿä¸€å¤„ç†
   - ç‰¹æ®Šé”™è¯¯: ç»„ä»¶ä¸­å•ç‹¬å¤„ç†

### âŒ é¿å…çš„åšæ³•

1. âŒ ä¸è¦åœ¨ Service ä¸­ä½¿ç”¨ `console.log`
2. âŒ ä¸è¦ä½¿ç”¨ `throw new Error()`
3. âŒ ä¸è¦ç¡¬ç¼–ç é”™è¯¯æ¶ˆæ¯
4. âŒ ä¸è¦åœ¨æ‹¦æˆªå™¨ä¸­å¤„ç†æ‰€æœ‰ç‰¹æ®Šæƒ…å†µ

## é”™è¯¯ç åˆ†ç±»

| èŒƒå›´ | åˆ†ç±» | è¯´æ˜ |
|------|------|------|
| 10xxx | é€šç”¨é”™è¯¯ | æˆåŠŸã€å‚æ•°é”™è¯¯ã€æœåŠ¡å™¨é”™è¯¯ |
| 20xxx | è®¤è¯é”™è¯¯ | æœªç™»å½•ã€tokenè¿‡æœŸã€æ— æƒé™ |
| 30xxx | ç”¨æˆ·é”™è¯¯ | ç”¨æˆ·ç›¸å…³ä¸šåŠ¡é”™è¯¯ |
| 40xxx | è§’è‰²é”™è¯¯ | è§’è‰²ç›¸å…³ä¸šåŠ¡é”™è¯¯ |
| 50xxx | éƒ¨é—¨é”™è¯¯ | éƒ¨é—¨ç›¸å…³ä¸šåŠ¡é”™è¯¯ |
| 60xxx | èœå•é”™è¯¯ | èœå•ç›¸å…³ä¸šåŠ¡é”™è¯¯ |

## å‚è€ƒèµ„æº

- åç«¯å¼‚å¸¸å¤„ç†: `src/common/exceptions/business.exception.ts`
- å‰ç«¯æ‹¦æˆªå™¨: `src/utils/request.ts`
- é”™è¯¯ç å®šä¹‰: `src/common/enums/error-code.enum.ts`

---

**æœ€åæ›´æ–°:** 2025-12-05

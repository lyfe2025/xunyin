# 日志系统说明

## 概述

项目集成了基于 **Winston** 的完整日志系统,支持文件轮转、多级别日志、结构化输出等生产级特性。

## 日志级别

Winston 支持以下日志级别(优先级从高到低):

- `error` (0): 错误信息
- `warn` (1): 警告信息
- `info` (2): 一般信息
- `http` (3): HTTP 请求日志
- `verbose` (4): 详细信息
- `debug` (5): 调试信息
- `silly` (6): 最详细的信息

## 环境变量配置

在 `.env` 文件中配置日志相关参数:

```bash
# 日志级别(默认: info)
LOG_LEVEL=info

# 日志文件目录(默认: logs)
LOG_DIR=logs

# 运行环境(默认: development)
NODE_ENV=production
```

## 日志文件结构

日志文件按类型和日期自动分割:

```
logs/
├── application-2024-12-05.log      # 所有 info 及以上级别的日志
├── error-2024-12-05.log            # 错误日志
├── http-2024-12-05.log             # HTTP 请求日志
├── exceptions-2024-12-05.log       # 未捕获的异常
└── rejections-2024-12-05.log       # 未处理的 Promise 拒绝
```

### 日志轮转策略

- **按日期轮转**: 每天生成新的日志文件
- **文件大小限制**: 单个文件最大 20MB
- **保留时间**: 保留最近 14 天的日志
- **自动压缩**: 旧日志文件自动压缩为 `.gz` 格式

## 使用方法

### 1. 在 Service 中使用

```typescript
import { Injectable } from '@nestjs/common';
import { LoggerService } from '../common/logger/logger.service';

@Injectable()
export class UserService {
  constructor(private readonly logger: LoggerService) {}

  async createUser(data: CreateUserDto) {
    this.logger.log('Creating new user', 'UserService');
    
    try {
      // 业务逻辑
      const user = await this.userRepository.create(data);
      this.logger.log(`User created: ${user.id}`, 'UserService');
      return user;
    } catch (error) {
      this.logger.error(
        `Failed to create user: ${error.message}`,
        error.stack,
        'UserService',
      );
      throw error;
    }
  }
}
```

### 2. 在 Controller 中使用

```typescript
import { Controller, Get } from '@nestjs/common';
import { LoggerService } from '../common/logger/logger.service';

@Controller('users')
export class UserController {
  constructor(private readonly logger: LoggerService) {}

  @Get()
  findAll() {
    this.logger.debug('Fetching all users', 'UserController');
    // 业务逻辑
  }
}
```

### 3. HTTP 请求日志

HTTP 请求日志由 `HttpLoggerMiddleware` 自动记录,包含:

- 请求方法和 URL
- 响应状态码
- 响应时间
- IP 地址
- User-Agent

示例输出:

```json
{
  "level": "http",
  "message": "GET /api/users 200 1234 - 45ms",
  "timestamp": "2024-12-05 10:30:15",
  "method": "GET",
  "url": "/api/users",
  "statusCode": 200,
  "contentLength": "1234",
  "responseTime": 45,
  "ip": "127.0.0.1",
  "userAgent": "Mozilla/5.0..."
}
```

### 4. 异常日志

全局异常过滤器 `AllExceptionsFilter` 自动记录所有未捕获的异常:

```json
{
  "level": "error",
  "message": "[GET] /api/users/123 - User not found",
  "timestamp": "2024-12-05 10:30:15",
  "context": "AllExceptionsFilter",
  "trace": "Error: User not found\n    at UserService.findOne..."
}
```

## 日志格式

### 开发环境

使用彩色、易读的格式输出到控制台:

```
[Nest] 12345  - 2024-12-05 10:30:15   LOG [UserService] Creating new user
[Nest] 12345  - 2024-12-05 10:30:16 ERROR [UserService] Failed to create user
```

### 生产环境

使用 JSON 格式输出,便于日志收集和分析:

```json
{
  "level": "info",
  "message": "Creating new user",
  "timestamp": "2024-12-05 10:30:15",
  "context": "UserService"
}
```

## 最佳实践

### 1. 选择合适的日志级别

- `error`: 系统错误、异常
- `warn`: 警告信息、降级操作
- `info`: 重要的业务流程节点
- `http`: HTTP 请求(已自动记录)
- `debug`: 调试信息(仅开发环境)

### 2. 提供上下文信息

```typescript
// ✅ 好的做法
this.logger.log('User created successfully', 'UserService');
this.logger.error('Database connection failed', error.stack, 'DatabaseService');

// ❌ 避免
this.logger.log('Success');
this.logger.error('Error');
```

### 3. 记录关键业务操作

```typescript
// 用户登录
this.logger.log(`User ${username} logged in from ${ip}`, 'AuthService');

// 数据修改
this.logger.log(`User ${userId} updated profile`, 'UserService');

// 权限变更
this.logger.warn(`User ${userId} permission changed by ${adminId}`, 'RoleService');
```

### 4. 避免记录敏感信息

```typescript
// ❌ 不要记录密码、Token 等敏感信息
this.logger.log(`Login with password: ${password}`);

// ✅ 只记录必要的非敏感信息
this.logger.log(`User ${username} attempting login`);
```

### 5. 使用结构化日志

```typescript
// 对于复杂的日志信息,使用 http 方法记录结构化数据
this.logger.http('Payment processed', {
  orderId: '12345',
  amount: 99.99,
  currency: 'USD',
  status: 'success',
});
```

## 日志监控建议

### 生产环境

1. **日志收集**: 使用 ELK (Elasticsearch + Logstash + Kibana) 或类似工具收集日志
2. **日志告警**: 配置错误日志告警,及时发现问题
3. **日志分析**: 定期分析日志,发现性能瓶颈和异常模式
4. **日志归档**: 定期归档历史日志到对象存储

### 开发环境

1. **实时查看**: 使用 `tail -f logs/application-*.log` 实时查看日志
2. **错误排查**: 查看 `logs/error-*.log` 快速定位错误
3. **性能分析**: 分析 `logs/http-*.log` 了解接口响应时间

## 常见问题

### Q: 如何修改日志级别?

A: 修改 `.env` 文件中的 `LOG_LEVEL` 变量,重启应用即可。

### Q: 日志文件占用空间过大怎么办?

A: 调整 `logger.config.ts` 中的 `maxSize` 和 `maxFiles` 参数:

```typescript
maxSize: '20m',  // 单文件大小
maxFiles: '14d', // 保留天数
```

### Q: 如何在生产环境禁用控制台日志?

A: 修改 `logger.config.ts`,移除或注释掉 Console transport:

```typescript
transports: [
  // new winston.transports.Console({ ... }), // 注释掉
  createRotateTransport('info', 'application'),
  // ...
],
```

### Q: 如何集成到日志监控平台?

A: Winston 支持自定义 transport,可以添加发送到远程日志服务的 transport:

```typescript
import { Logtail } from '@logtail/node';
import { LogtailTransport } from '@logtail/winston';

const logtail = new Logtail('your-source-token');

transports: [
  new LogtailTransport(logtail),
  // ... 其他 transports
]
```

## 相关文件

- `src/common/logger/logger.config.ts` - 日志配置
- `src/common/logger/logger.service.ts` - 日志服务
- `src/common/logger/logger.module.ts` - 日志模块
- `src/common/middleware/http-logger.middleware.ts` - HTTP 日志中间件
- `src/common/filters/all-exceptions.filter.ts` - 异常日志过滤器

# 实用测试策略

> 适合中小型项目的轻量级测试方案

## 💡 核心理念

**不写单元测试,但要保证质量** - 通过以下方式替代传统单元测试:

1. ✅ **TypeScript 类型检查** - 编译时发现大部分错误
2. ✅ **Swagger API 文档** - 手动测试 + 文档化
3. ✅ **冒烟测试脚本** - 快速验证核心功能
4. ✅ **代码审查** - 人工质量把关
5. ✅ **生产监控** - 及时发现问题

## 🎯 三层测试策略

### 第一层: 开发时检查 (自动)

**TypeScript 类型检查**
```bash
# 前端
cd web && npm run type-check

# 后端
cd server-nestjs && npm run check
```

**ESLint 代码检查**
```bash
# 前端
cd web && npm run lint

# 后端
cd server-nestjs && npm run lint
```

**Prisma Schema 验证**
```bash
cd server-nestjs && npx prisma validate
```

### 第二层: 功能验证 (半自动)

**API 冒烟测试**

项目已有冒烟测试脚本,位于 `server-nestjs/`:
- `test-login.sh` - 登录测试
- `test-getinfo.sh` - 获取用户信息
- `test-getrouters.sh` - 获取路由
- `test-user.sh` - 用户管理
- `test-role.sh` - 角色管理
- `test-dept.sh` - 部门管理
- `test-menu.sh` - 菜单管理

**一键运行所有测试:**
```bash
./monorepo.sh --action 8
# 或
cd server-nestjs && bash run-all-tests.sh
```

**Swagger 手动测试**
1. 访问 http://localhost:3000/api-docs
2. 使用 Swagger UI 测试每个接口
3. 验证请求/响应格式
4. 检查错误处理

### 第三层: 集成验证 (手动)

**关键业务流程测试清单**

创建一个测试清单,每次发布前手动验证:

```markdown
## 发布前测试清单

### 认证流程
- [ ] 用户登录 (正确密码)
- [ ] 用户登录 (错误密码)
- [ ] Token 过期处理
- [ ] 退出登录

### 用户管理
- [ ] 创建用户
- [ ] 编辑用户
- [ ] 删除用户
- [ ] 重置密码
- [ ] 分配角色

### 权限验证
- [ ] 菜单权限显示
- [ ] 按钮权限控制
- [ ] API 权限拦截

### 数据操作
- [ ] 列表查询
- [ ] 分页功能
- [ ] 搜索过滤
- [ ] 排序功能

### 异常处理
- [ ] 网络错误提示
- [ ] 参数验证错误
- [ ] 权限不足提示
- [ ] 服务器错误处理
```

## 🛠️ 实用工具推荐

### 1. Postman / Insomnia
- 保存常用 API 请求
- 创建测试集合
- 导出分享给团队

### 2. Browser DevTools
- Network 面板检查请求
- Console 查看错误
- Application 检查存储

### 3. 数据库客户端
- DBeaver / TablePlus
- 直接查看数据变化
- 验证数据完整性

## 📝 测试文档化

### API 测试用例文档

创建简单的测试用例文档:

```markdown
# API 测试用例

## 用户登录 POST /auth/login

### 测试用例 1: 正常登录
**请求:**
```json
{
  "username": "admin",
  "password": "admin123"
}
```

**期望响应:**
- 状态码: 200
- 返回 token
- 返回用户信息

### 测试用例 2: 密码错误
**请求:**
```json
{
  "username": "admin",
  "password": "wrong"
}
```

**期望响应:**
- 状态码: 401
- 错误消息: "用户名或密码错误"
```

## 🚀 快速验证脚本

### 健康检查脚本

```bash
#!/bin/bash
# health-check.sh

echo "🔍 检查服务健康状态..."

# 检查后端
echo "检查后端服务..."
curl -f http://localhost:3000/health || echo "❌ 后端服务异常"

# 检查前端
echo "检查前端服务..."
curl -f http://localhost:5173 || echo "❌ 前端服务异常"

# 检查数据库
echo "检查数据库连接..."
cd server-nestjs && npx prisma db pull --force || echo "❌ 数据库连接异常"

# 检查 Redis
echo "检查 Redis 连接..."
redis-cli ping || echo "❌ Redis 连接异常"

echo "✅ 健康检查完成"
```

### 数据一致性检查

```bash
#!/bin/bash
# data-check.sh

echo "🔍 检查数据一致性..."

# 检查用户-角色关联
echo "检查用户角色关联..."
# SQL 查询检查孤立数据

# 检查角色-菜单关联
echo "检查角色菜单关联..."
# SQL 查询检查孤立数据

echo "✅ 数据检查完成"
```

## 📊 质量保障措施

### 代码层面
1. ✅ TypeScript 严格模式
2. ✅ ESLint 规则检查
3. ✅ Prettier 代码格式化
4. ✅ Git pre-commit hook

### 开发流程
1. ✅ 功能开发完成后自测
2. ✅ 使用 Swagger 验证 API
3. ✅ 运行冒烟测试脚本
4. ✅ 代码审查 (如果是团队)

### 部署流程
1. ✅ 本地完整测试
2. ✅ 测试环境验证
3. ✅ 生产环境灰度发布
4. ✅ 监控告警

## 🎓 何时需要单元测试?

如果项目出现以下情况,再考虑添加单元测试:

1. **团队规模扩大** - 多人协作需要测试保障
2. **核心业务复杂** - 复杂的业务逻辑需要测试覆盖
3. **频繁重构** - 测试可以保证重构不破坏功能
4. **长期维护** - 项目需要长期维护和迭代
5. **质量要求高** - 金融、医疗等对质量要求极高的领域

## 💰 成本收益分析

### 不写单元测试
**优点:**
- ⚡ 开发速度快
- 💰 人力成本低
- 🔄 迭代灵活

**缺点:**
- ⚠️ 重构风险高
- 🐛 Bug 发现晚
- 📉 长期维护成本高

### 写单元测试
**优点:**
- ✅ 代码质量高
- 🛡️ 重构有保障
- 📚 文档化

**缺点:**
- 🐌 开发速度慢
- 💸 初期成本高
- 🔧 维护测试代码

## 🎯 推荐方案

**对于当前项目:**

1. **现阶段 (MVP/快速开发)**
   - ✅ 使用 TypeScript + ESLint
   - ✅ 使用 Swagger 手动测试
   - ✅ 使用冒烟测试脚本
   - ❌ 不写单元测试

2. **成熟阶段 (稳定运行)**
   - ✅ 为核心业务逻辑添加单元测试
   - ✅ 添加 E2E 测试
   - ✅ 集成 CI/CD 自动化测试

3. **长期维护 (持续迭代)**
   - ✅ 完整的测试覆盖
   - ✅ 测试驱动开发 (TDD)
   - ✅ 自动化测试 + 代码覆盖率

## 📚 参考资源

- [测试金字塔](https://martinfowler.com/articles/practical-test-pyramid.html)
- [Google 测试博客](https://testing.googleblog.com/)
- [测试的成本与收益](https://kentcdodds.com/blog/write-tests)

---

**结论**: 对于中小型项目,**实用主义 > 完美主义**。先保证功能正确,再逐步完善测试。

**最后更新**: 2025-12-09
